!(function(){"use strict";var yt=Object.defineProperty;var He=w=>{throw TypeError(w)};var xt=(w,y,S)=>y in w?yt(w,y,{enumerable:!0,configurable:!0,writable:!0,value:S}):w[y]=S;var _=(w,y,S)=>xt(w,typeof y!="symbol"?y+"":y,S),Se=(w,y,S)=>y.has(w)||He("Cannot "+S);var c=(w,y,S)=>(Se(w,y,"read from private field"),S?S.call(w):y.get(w)),b=(w,y,S)=>y.has(w)?He("Cannot add the same private member more than once"):y instanceof WeakSet?y.add(w):y.set(w,S),A=(w,y,S,L)=>(Se(w,y,"write to private field"),L?L.call(w,S):y.set(w,S),S),te=(w,y,S)=>(Se(w,y,"access private method"),S);var Te=(w,y,S,L)=>({set _(E){A(w,y,E,S)},get _(){return c(w,y,L)}});(self.webpackChunkreact_book_reader_docs=self.webpackChunkreact_book_reader_docs||[]).push([[453],{50453:function(w,y,S){var $,q,P,ne,re,ie,V,oe,z,Ae,Ne,H,Z,N,B,ae,ce,v,Y,X,G,j,U,O,I,pe,be,F,le,he,ke;S.d(y,{MOBI:function(){return lt},isMOBI:function(){return at}});const L=o=>{if(!o)return"";const t=document.createElement("textarea");return t.innerHTML=o,t.value},E={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},Xe={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},Ge={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},je={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},_e={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},$e={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},Le={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},qe={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},Pe={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},Ve={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},Ze={magic:[0,4,"string"],numEntries:[8,4,"uint"]},Ye={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},Ke={1252:"windows-1252",65001:"utf-8"},Me={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},We={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},ye=(o,t)=>{const e=new o.constructor(o.length+t.length);return e.set(o),e.set(t,o.length),e},Ee=(o,t,e)=>{const s=new o.constructor(o.length+t.length+e.length);return s.set(o),s.set(t,o.length),s.set(e,o.length+t.length),s},Je=new TextDecoder,se=o=>Je.decode(o),k=o=>{if(!o)return;const t=o.byteLength,e=t===4?"getUint32":t===2?"getUint16":"getUint8";return new DataView(o)[e](0)},M=(o,t)=>Object.fromEntries(Array.from(Object.entries(o)).map(([e,[s,r,n]])=>[e,(n==="string"?se:k)(t.slice(s,s+r))])),xe=o=>new TextDecoder(Ke[o]),ge=(o,t=0)=>{let e=0,s=0;for(const r of o.subarray(t,t+4))if(e=e<<7|(r&127)>>>0,s++,r&128)break;return{value:e,length:s}},Qe=o=>{let t=0;for(const e of o.subarray(-4))e&128&&(t=0),t=t<<7|e&127;return t},Ce=o=>{let t=0;for(;o>0;o=o>>1)(o&1)===1&&t++;return t},et=o=>{let t=0;for(;!(o&1);)o=o>>1,t++;return t},tt=o=>{let t=[];for(let e=0;e<o.length;e++){const s=o[e];if(s===0)t.push(0);else if(s<=8)for(const r of o.subarray(e+1,(e+=s)+1))t.push(r);else if(s<=127)t.push(s);else if(s<=191){const r=s<<8|o[e+++1],n=(r&16383)>>>3,i=(r&7)+3;for(let h=0;h<i;h++)t.push(t[t.length-n])}else t.push(32,s^128)}return Uint8Array.from(t)},st=(o,t)=>{const e=t>>3,s=t+32,r=s>>3;let n=0n;for(let i=e;i<=r;i++)n=n<<8n|BigInt(o[i]??0);return n>>8n-BigInt(s&7)&0xffffffffn},nt=async(o,t)=>{const e=await t(o.huffcdic),{magic:s,offset1:r,offset2:n}=M(Pe,e);if(s!=="HUFF")throw new Error("Invalid HUFF record");const i=Array.from({length:256},(a,g)=>r+g*4).map(a=>k(e.slice(a,a+4))).map(a=>[a&128,a&31,a>>>8]),h=[null].concat(Array.from({length:32},(a,g)=>n+g*8).map(a=>[k(e.slice(a,a+4)),k(e.slice(a+4,a+8))])),u=[];for(let a=1;a<o.numHuffcdic;a++){const g=await t(o.huffcdic+a),f=M(Ve,g);if(f.magic!=="CDIC")throw new Error("Invalid CDIC record");const d=Math.min(1<<f.codeLength,f.numEntries-u.length),m=g.slice(f.length);for(let p=0;p<d;p++){const x=k(m.slice(p*2,p*2+2)),R=k(m.slice(x,x+2)),T=R&32767,C=R&32768,ue=new Uint8Array(m.slice(x+2,x+2+T));u.push([ue,C])}}const l=a=>{let g=new Uint8Array;const f=a.byteLength*8;for(let d=0;d<f;){const m=Number(st(a,d));let[p,x,R]=i[m>>>24];if(!p){for(;m>>>32-x<h[x][0];)x+=1;R=h[x][1]}if((d+=x)>f)break;const T=R-(m>>>32-x);let[C,ue]=u[T];ue||(C=l(C),u[T]=[C,!0]),g=ye(g,C)}return g};return l},me=async(o,t)=>{const e=await t(o),s=M(Le,e);if(s.magic!=="INDX")throw new Error("Invalid INDX record");const r=xe(s.encoding),n=e.slice(s.length),i=M(qe,n);if(i.magic!=="TAGX")throw new Error("Invalid TAGX section");const h=(i.length-12)/4,u=Array.from({length:h},(f,d)=>new Uint8Array(n.slice(12+d*4,12+d*4+4))),l={};let a=0;for(let f=0;f<s.numCncx;f++){const d=await t(o+s.numRecords+f+1),m=new Uint8Array(d);for(let p=0;p<m.byteLength;){const x=p,{value:R,length:T}=ge(m,p);p+=T;const C=d.slice(p,p+R);p+=R,l[a+x]=r.decode(C)}a+=65536}const g=[];for(let f=0;f<s.numRecords;f++){const d=await t(o+1+f),m=new Uint8Array(d),p=M(Le,d);if(p.magic!=="INDX")throw new Error("Invalid INDX record");for(let x=0;x<p.numRecords;x++){const R=p.idxt+4+2*x,T=k(d.slice(R,R+2)),C=k(d.slice(T,T+1)),ue=se(d.slice(T+1,T+1+C)),we=[],Fe=T+1+C;let De=0,K=Fe+i.numControlBytes;for(const[de,W,J,Re]of u){if(Re&1){De++;continue}const Q=Fe+De,D=k(d.slice(Q,Q+1))&J;if(D===J)if(Ce(J)>1){const{value:fe,length:ee}=ge(m,K);we.push([de,null,fe,W]),K+=ee}else we.push([de,1,null,W]);else we.push([de,D>>et(J),null,W])}const ze={};for(const[de,W,J,Re]of we){const Q=[];if(W!=null)for(let D=0;D<W*Re;D++){const{value:fe,length:ee}=ge(m,K);Q.push(fe),K+=ee}else{let D=0;for(;D<J;){const{value:fe,length:ee}=ge(m,K);Q.push(fe),K+=ee,D+=ee}}ze[de]=Q}g.push({name:ue,tagMap:ze})}}return{table:g,cncx:l}},rt=async(o,t)=>{const{table:e,cncx:s}=await me(o,t),r=e.map(({tagMap:i},h)=>({index:h,offset:i[1]?.[0],size:i[2]?.[0],label:s[i[3]]??"",headingLevel:i[4]?.[0],pos:i[6],parent:i[21]?.[0],firstChild:i[22]?.[0],lastChild:i[23]?.[0]})),n=i=>(i.firstChild==null||(i.children=r.filter(h=>h.parent===i.index).map(n)),i);return r.filter(i=>i.headingLevel===0).map(n)},it=(o,t)=>{const{magic:e,count:s}=M($e,o);if(e!=="EXTH")throw new Error("Invalid EXTH header");const r=xe(t),n={};let i=12;for(let h=0;h<s;h++){const u=k(o.slice(i,i+4)),l=k(o.slice(i+4,i+8));if(u in Me){const[a,g,f]=Me[u],d=o.slice(i+8,i+l),m=g==="uint"?k(d):r.decode(d);f?(n[a]??(n[a]=[]),n[a].push(m)):n[a]=m}i+=l}return n},ot=async(o,t)=>{const{flags:e,dataStart:s,keyLength:r,keyStart:n}=M(Ye,o),i=new Uint8Array(o.slice(s));if(e&2){const u=r===16?1024:1040,l=new Uint8Array(o.slice(n,n+r)),a=Math.min(u,i.length);for(var h=0;h<a;h++)i[h]=i[h]^l[h%l.length]}if(e&1)try{return await t(i)}catch(u){console.warn(u),console.warn("Failed to decompress font")}return i},at=async o=>se(await o.slice(60,68).arrayBuffer())==="BOOKMOBI";class ct{constructor(){b(this,$);b(this,q);_(this,"pdb")}async open(t){A(this,$,t);const e=M(Xe,await t.slice(0,78).arrayBuffer());this.pdb=e;const s=await t.slice(78,78+e.numRecords*8).arrayBuffer();A(this,q,Array.from({length:e.numRecords},(r,n)=>k(s.slice(n*8,n*8+4))).map((r,n,i)=>[r,i[n+1]]))}loadRecord(t){const e=c(this,q)[t];if(!e)throw new RangeError("Record index out of bounds");return c(this,$).slice(...e).arrayBuffer()}async loadMagic(t){const e=c(this,q)[t][0];return se(await c(this,$).slice(e,e+4).arrayBuffer())}}$=new WeakMap,q=new WeakMap;class lt extends ct{constructor({unzlib:e}){super();b(this,z);b(this,P,0);b(this,ne);b(this,re);b(this,ie);b(this,V);b(this,oe);this.unzlib=e}async open(e){await super.open(e),this.headers=te(this,z,Ae).call(this,await super.loadRecord(0)),A(this,ne,this.headers.mobi.resourceStart);let s=this.headers.mobi.version>=8;if(!s){const r=this.headers.exth?.boundary;if(r<4294967295)try{this.headers=te(this,z,Ae).call(this,await super.loadRecord(r)),A(this,P,r),s=!0}catch(n){console.warn(n),console.warn("Failed to open KF8; falling back to MOBI")}}return await te(this,z,Ne).call(this),s?new wt(this).init():new ft(this).init()}decode(...e){return c(this,re).decode(...e)}encode(...e){return c(this,ie).encode(...e)}loadRecord(e){return super.loadRecord(c(this,P)+e)}loadMagic(e){return super.loadMagic(c(this,P)+e)}loadText(e){return this.loadRecord(e+1).then(s=>new Uint8Array(s)).then(c(this,oe)).then(c(this,V))}async loadResource(e){const s=await super.loadRecord(c(this,ne)+e),r=se(s.slice(0,4));return r==="FONT"?ot(s,this.unzlib):r==="VIDE"||r==="AUDI"?s.slice(12):s}getNCX(){const e=this.headers.mobi.indx;if(e<4294967295)return rt(e,this.loadRecord.bind(this))}getMetadata(){const{mobi:e,exth:s}=this.headers;return{identifier:e.uid.toString(),title:L(s?.title||this.decode(e.title)),author:s?.creator?.map(L),publisher:L(s?.publisher),language:s?.language??e.language,published:s?.date,description:L(s?.description),subject:s?.subject?.map(L),rights:L(s?.rights),contributor:s?.contributor}}async getCover(){const{exth:e}=this.headers,s=e?.coverOffset<4294967295?e?.coverOffset:e?.thumbnailOffset<4294967295?e?.thumbnailOffset:null;if(s!=null){const r=await this.loadResource(s);return new Blob([r])}}}P=new WeakMap,ne=new WeakMap,re=new WeakMap,ie=new WeakMap,V=new WeakMap,oe=new WeakMap,z=new WeakSet,Ae=function(e){const s=M(Ge,e),r=M(je,e);if(r.magic!=="MOBI")throw new Error("Missing MOBI header");const{titleOffset:n,titleLength:i,localeLanguage:h,localeRegion:u}=r;r.title=e.slice(n,n+i);const l=We[h];r.language=l?.[u>>2]??l?.[0];const a=r.exthFlag&64?it(e.slice(r.length+16),r.encoding):null,g=r.version>=8?M(_e,e):null;return{palmdoc:s,mobi:r,exth:a,kf8:g}},Ne=async function(){const{palmdoc:e,mobi:s}=this.headers;A(this,re,xe(s.encoding)),A(this,ie,new TextEncoder);const{compression:r}=e;if(A(this,V,r===1?u=>u:r===2?tt:r===17480?await nt(s,this.loadRecord.bind(this)):null),!c(this,V))throw new Error("Unknown compression type");const{trailingFlags:n}=s,i=n&1,h=Ce(n>>>1);A(this,oe,u=>{for(let l=0;l<h;l++){const a=Qe(u);u=u.subarray(0,-a)}if(i){const l=(u[u.length-1]&3)+1;u=u.subarray(0,-l)}return u})};const ve=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,ht=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi,ut=o=>{let t=0;for(;o;){const e=o.parentElement;if(e){const s=e.tagName.toLowerCase();s==="p"?t+=1.5:s==="blockquote"&&(t+=2)}o=e}return t};function dt(o){let t="";for(let e=0;e<o.length;e+=32768)t+=String.fromCharCode.apply(null,o.subarray(e,e+32768));return t}class ft{constructor(t){_(this,"parser",new DOMParser);_(this,"serializer",new XMLSerializer);b(this,H,new Map);b(this,Z,new Map);b(this,N,new Map);b(this,B);b(this,ae,[]);b(this,ce,E.HTML);this.mobi=t}async init(){const t=[];for(let n=0;n<this.mobi.headers.palmdoc.numTextRecords;n++){const i=await this.mobi.loadText(n);t.push(i)}const e=t.reduce((n,i)=>n+i.byteLength,0),s=new Uint8Array(e);t.reduce((n,i)=>(s.set(new Uint8Array(i),n),n+i.byteLength),0);const r=dt(s);A(this,B,[0].concat(Array.from(r.matchAll(ve),n=>n.index)).map((n,i,h)=>{const u=h[i+1]??s.length;return{book:this,raw:s.subarray(n,u)}}).map((n,i,h)=>(n.start=h[i-1]?.end??0,n.end=n.start+n.raw.byteLength,n))),this.sections=c(this,B).map((n,i)=>({id:i,load:()=>this.loadSection(n),createDocument:()=>this.createDocument(n),size:n.end-n.start}));try{this.landmarks=await this.getGuide();const n=this.landmarks.find(({type:i})=>i?.includes("toc"))?.href;if(n){const{index:i}=this.resolveHref(n),h=await this.sections[i].createDocument();let u,l=0,a=0;const g=new Map,f=new Map;this.toc=Array.from(h.querySelectorAll("a[filepos]")).reduce((d,m)=>{const p=ut(m),x={label:m.innerText?.trim()??"",href:`filepos:${m.getAttribute("filepos")}`},R=p>a?l+1:p===a?l:g.get(p)??Math.max(0,l-1);if(R>l)u?(u.subitems??(u.subitems=[]),u.subitems.push(x),f.set(R,u)):d.push(x);else{const T=f.get(R);T?T.subitems.push(x):d.push(x)}return u=x,l=R,a=p,g.set(p,R),d},[])}}catch(n){console.warn(n)}return A(this,ae,[...new Set(Array.from(r.matchAll(ht),n=>n[1]))].map(n=>({filepos:n,number:Number(n)})).sort((n,i)=>n.number-i.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const t=await this.createDocument(c(this,B)[0]);return Array.from(t.getElementsByTagName("reference"),e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`}))}async loadResource(t){if(c(this,H).has(t))return c(this,H).get(t);const e=await this.mobi.loadResource(t),s=URL.createObjectURL(new Blob([e]));return c(this,H).set(t,s),s}async loadRecindex(t){return this.loadResource(Number(t)-1)}async replaceResources(t){for(const e of t.querySelectorAll("img[recindex]")){const s=e.getAttribute("recindex");try{e.src=await this.loadRecindex(s)}catch{console.warn(`Failed to load image ${s}`)}}for(const e of t.querySelectorAll("[mediarecindex]")){const s=e.getAttribute("mediarecindex"),r=e.getAttribute("recindex");try{e.src=await this.loadRecindex(s),r&&(e.poster=await this.loadRecindex(r))}catch{console.warn(`Failed to load media ${s}`)}}for(const e of t.querySelectorAll("[filepos]")){const s=e.getAttribute("filepos");e.href=`filepos:${s}`}}async loadText(t){if(c(this,Z).has(t))return c(this,Z).get(t);const{raw:e}=t,s=c(this,ae).filter(({number:i})=>i>=t.start&&i<t.end).map(i=>({...i,offset:i.number-t.start}));let r=e;s.length&&(r=e.subarray(0,s[0].offset),s.forEach(({filepos:i,offset:h},u)=>{const l=s[u+1],a=this.mobi.encode(`<a id="filepos${i}"></a>`);r=Ee(r,a,e.subarray(h,l?.offset))}));const n=this.mobi.decode(r).replaceAll(ve,"");return c(this,Z).set(t,n),n}async createDocument(t){const e=await this.loadText(t);return this.parser.parseFromString(e,c(this,ce))}async loadSection(t){if(c(this,N).has(t))return c(this,N).get(t);const e=await this.createDocument(t),s=e.createElement("style");e.head.append(s),s.append(e.createTextNode(`blockquote {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-inline-start: 1em;
            margin-inline-end: 0;
        }`)),await this.replaceResources(e);const r=this.serializer.serializeToString(e),n=URL.createObjectURL(new Blob([r],{type:c(this,ce)}));return c(this,N).set(t,n),n}resolveHref(t){const e=t.match(/filepos:(.*)/)[1],s=Number(e);return{index:c(this,B).findIndex(r=>r.end>s),anchor:r=>r.getElementById(`filepos${e}`)}}splitTOCHref(t){const e=t.match(/filepos:(.*)/)[1],s=Number(e);return[c(this,B).findIndex(r=>r.end>s),`filepos${e}`]}getTOCFragment(t,e){return t.getElementById(e)}isExternal(t){return/^(?!blob|filepos)\w+:/i.test(t)}destroy(){for(const t of c(this,H).values())URL.revokeObjectURL(t);for(const t of c(this,N).values())URL.revokeObjectURL(t)}}H=new WeakMap,Z=new WeakMap,N=new WeakMap,B=new WeakMap,ae=new WeakMap,ce=new WeakMap;const Ie=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,gt=/kindle:pos:fid:(\w+):off:(\w+)/,mt=o=>{const[t,e,s]=o.match(Ie).slice(1);return{resourceType:t,id:parseInt(e,32),type:s}},Be=o=>{const[t,e]=o.match(gt).slice(1);return{fid:parseInt(t,32),off:parseInt(e,32)}},Ue=(o=0,t=0)=>`kindle:pos:fid:${o.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,Oe=o=>{const t=o.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,e,s]=t;return`[${e}="${CSS.escape(s)}"]`},pt=async(o,t,e)=>{const s=[];o.replace(t,(...n)=>(s.push(n),null));const r=[];for(const n of s)r.push(await e(...n));return o.replace(t,()=>r.shift())},bt=o=>{for(const t of o){if(t==="page-spread-left"||t==="rendition:page-spread-left")return"left";if(t==="page-spread-right"||t==="rendition:page-spread-right")return"right";if(t==="rendition:page-spread-center")return"center"}};class wt{constructor(t){b(this,he);_(this,"parser",new DOMParser);_(this,"serializer",new XMLSerializer);_(this,"transformTarget",new EventTarget);b(this,v,new Map);b(this,Y,new Map);b(this,X,new Map);b(this,G,{});b(this,j);b(this,U);b(this,O,new Uint8Array);b(this,I,new Uint8Array);b(this,pe,-1);b(this,be,-1);b(this,F,E.XHTML);b(this,le,new Map);this.mobi=t}async init(){const t=this.mobi.loadRecord.bind(this.mobi),{kf8:e}=this.mobi.headers;try{const l=await t(e.fdst),a=M(Ze,l);if(a.magic!=="FDST")throw new Error("Missing FDST record");const g=Array.from({length:a.numEntries},(f,d)=>12+d*8).map(f=>[k(l.slice(f,f+4)),k(l.slice(f+4,f+8))]);c(this,G).fdstTable=g,A(this,U,g[g.length-1][1])}catch{}const s=(await me(e.skel,t)).table.map(({name:l,tagMap:a},g)=>({index:g,name:l,numFrag:a[1][0],offset:a[6][0],length:a[6][1]})),r=await me(e.frag,t),n=r.table.map(({name:l,tagMap:a})=>({insertOffset:parseInt(l),selector:r.cncx[a[2][0]],index:a[4][0],offset:a[6][0],length:a[6][1]}));c(this,G).skelTable=s,c(this,G).fragTable=n,A(this,j,s.reduce((l,a)=>{const g=l[l.length-1],f=g?.fragEnd??0,d=f+a.numFrag,m=n.slice(f,d),p=a.length+m.map(R=>R.length).reduce((R,T)=>R+T,0),x=(g?.totalLength??0)+p;return l.concat({skel:a,frags:m,fragEnd:d,length:p,totalLength:x})},[]));const i=await this.getResourcesByMagic(["RESC","PAGE"]),h=new Map;if(i.RESC){const l=await this.mobi.loadRecord(i.RESC),a=this.mobi.decode(l.slice(16)).replace(/\0/g,""),g=a.search(/\?>/),f=`<package>${a.slice(g)}</package>`,d=this.parser.parseFromString(f,E.XML);for(const m of d.querySelectorAll("spine > itemref")){const p=parseInt(m.getAttribute("skelid"));h.set(p,bt(m.getAttribute("properties")?.split(" ")??[]))}}this.sections=c(this,j).map((l,a)=>l.frags.length?{id:a,load:()=>this.loadSection(l),createDocument:()=>this.createDocument(l),size:l.length,pageSpread:h.get(a)}:{linear:"no"});try{const l=await this.mobi.getNCX(),a=({label:g,pos:f,children:d})=>{const[m,p]=f,x=Ue(m,p),R=c(this,Y).get(m);return R?R.push(p):c(this,Y).set(m,[p]),{label:L(g),href:x,subitems:d?.map(a)}};this.toc=l?.map(a),this.landmarks=await this.getGuide()}catch(l){console.warn(l)}const{exth:u}=this.mobi.headers;return this.dir=u.pageProgressionDirection,this.rendition={layout:u.fixedLayout==="true"?"pre-paginated":"reflowable",viewport:Object.fromEntries(u.originalResolution?.split("x")?.slice(0,2)?.map((l,a)=>[a?"height":"width",l])??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(t){const e={},s=this.mobi.headers.kf8.resourceStart,r=this.mobi.pdb.numRecords;for(let n=s;n<r;n++)try{const i=await this.mobi.loadMagic(n),h=t.find(u=>u===i);h&&(e[h]=n)}catch{}return e}async getGuide(){const t=this.mobi.headers.kf8.guide;if(t<4294967295){const e=this.mobi.loadRecord.bind(this.mobi),{table:s,cncx:r}=await me(t,e);return s.map(({name:n,tagMap:i})=>({label:r[i[1][0]]??"",type:n?.split(/\s/),href:Ue(i[6]?.[0]??i[3]?.[0])}))}}async loadResourceBlob(t){const{resourceType:e,id:s,type:r}=mt(t),n=e==="flow"?await this.loadFlow(s):await this.mobi.loadResource(s-1),i={data:[E.XHTML,E.HTML,E.CSS,E.SVG].includes(r)?await this.replaceResources(this.mobi.decode(n)):n,type:r},h=new CustomEvent("data",{detail:i});this.transformTarget.dispatchEvent(h);const u=await h.detail.data,l=await h.detail.type,a=l===E.SVG?this.parser.parseFromString(u,l):null;return[new Blob([u],{newType:l}),a?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?a.documentElement:null]}async loadResource(t){if(c(this,v).has(t))return c(this,v).get(t);const[e,s]=await this.loadResourceBlob(t),r=s?t:URL.createObjectURL(e);return s&&c(this,le).set(r,s),c(this,v).set(t,r),r}replaceResources(t){const e=new RegExp(Ie,"g");return pt(t,e,this.loadResource.bind(this))}async loadRaw(t,e){const s=e-c(this,O).length,r=c(this,U)==null?1/0:c(this,U)-c(this,I).length-t;if(s<0||s<r){for(;c(this,O).length<e;){const i=++Te(this,pe)._,h=await this.mobi.loadText(i);A(this,O,ye(c(this,O),h))}return c(this,O).slice(t,e)}for(;c(this,U)-c(this,I).length>t;){const i=this.mobi.headers.palmdoc.numTextRecords-1-++Te(this,be)._,h=await this.mobi.loadText(i);A(this,I,ye(h,c(this,I)))}const n=c(this,U)-c(this,I).length;return c(this,I).slice(t-n,e-n)}loadFlow(t){if(t<4294967295)return this.loadRaw(...c(this,G).fdstTable[t])}async loadText(t){const{skel:e,frags:s,length:r}=t,n=await this.loadRaw(e.offset,e.offset+r);let i=n.slice(0,e.length);for(const h of s){const u=h.insertOffset-e.offset,l=e.length+h.offset,a=n.slice(l,l+h.length);i=Ee(i.slice(0,u),a,i.slice(u));const g=c(this,Y).get(h.index);if(g)for(const f of g){const d=this.mobi.decode(a.slice(f)),m=Oe(d);te(this,he,ke).call(this,h.index,f,m)}}return this.mobi.decode(i)}async createDocument(t){const e=await this.loadText(t);return this.parser.parseFromString(e,c(this,F))}async loadSection(t){if(c(this,v).has(t))return c(this,v).get(t);const e=await this.loadText(t),s=await this.replaceResources(e);let r=this.parser.parseFromString(s,c(this,F));(r.querySelector("parsererror")||!r.documentElement?.namespaceURI)&&(A(this,F,E.HTML),r=this.parser.parseFromString(s,c(this,F)));for(const[i,h]of c(this,le))for(const u of r.querySelectorAll(`img[src="${i}"]`))u.replaceWith(h);const n=URL.createObjectURL(new Blob([this.serializer.serializeToString(r)],{type:c(this,F)}));return c(this,v).set(t,n),n}getIndexByFID(t){return c(this,j).findIndex(e=>e.frags.some(s=>s.index===t))}async resolveHref(t){const{fid:e,off:s}=Be(t),r=this.getIndexByFID(e);if(r<0)return;const n=c(this,X).get(e)?.get(s);if(n)return{index:r,anchor:d=>d.querySelector(n)};const{skel:i,frags:h}=c(this,j)[r],u=h.find(d=>d.index===e),l=i.offset+i.length+u.offset,a=await this.loadRaw(l,l+u.length),g=this.mobi.decode(a.slice(s)),f=Oe(g);return te(this,he,ke).call(this,e,s,f),{index:r,anchor:d=>d.querySelector(f)}}splitTOCHref(t){const e=Be(t);return[this.getIndexByFID(e.fid),e]}getTOCFragment(t,{fid:e,off:s}){const r=c(this,X).get(e)?.get(s);return t.querySelector(r)}isExternal(t){return/^(?!blob|kindle)\w+:/i.test(t)}destroy(){for(const t of c(this,v).values())URL.revokeObjectURL(t)}}v=new WeakMap,Y=new WeakMap,X=new WeakMap,G=new WeakMap,j=new WeakMap,U=new WeakMap,O=new WeakMap,I=new WeakMap,pe=new WeakMap,be=new WeakMap,F=new WeakMap,le=new WeakMap,he=new WeakSet,ke=function(t,e,s){const r=c(this,X).get(t);if(r)r.set(e,s);else{const n=new Map;c(this,X).set(t,n),n.set(e,s)}}}}]);
}());