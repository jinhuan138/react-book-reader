"use strict";(self.webpackChunkreact_book_reader_docs=self.webpackChunkreact_book_reader_docs||[]).push([[523],{24523:function(ce,Ft,$t){$t.d(Ft,{EPUB:function(){return oe}});var rt=$t(14589),Ht=Object.defineProperty,_t=(i,t,e)=>t in i?Ht(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,Bt=(i,t,e)=>(_t(i,typeof t!="symbol"?t+"":t,e),e),Tt=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)},a=(i,t,e)=>(Tt(i,t,"read from private field"),e?e.call(i):t.get(i)),S=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},T=(i,t,e,r)=>(Tt(i,t,"write to private field"),r?r.call(i,e):t.set(i,e),e),Dt=(i,t,e,r)=>({set _(s){T(i,t,s,e)},get _(){return a(i,t,r)}}),w=(i,t,e)=>(Tt(i,t,"access private method"),e);const A={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",DCTERMS:"http://purl.org/dc/terms/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},L={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},ut=i=>i.toLowerCase().replace(/[-:](.)/g,(t,e)=>e.toUpperCase()),jt=i=>i?i.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",st=(i,t,e)=>e?r=>{var s,n;return(n=(s=r.getAttribute(i))==null?void 0:s.split(/\s/))==null?void 0:n.includes(t)}:typeof t=="function"?r=>t(r.getAttribute(i)):r=>r.getAttribute(i)===t,dt=(...i)=>t=>t?Object.fromEntries(i.map(e=>[ut(e),t.getAttribute(e)])):null,$=i=>jt(i?.textContent),nt=(i,t)=>{const e=i.lookupNamespaceURI(null)===t||i.lookupPrefix(t),r=e?(s,n)=>l=>l.namespaceURI===t&&l.localName===n:(s,n)=>l=>l.localName===n;return{$:(s,n)=>[...s.children].find(r(s,n)),$$:(s,n)=>[...s.children].filter(r(s,n)),$$$:e?(s,n)=>[...s.getElementsByTagNameNS(t,n)]:(s,n)=>[...s.getElementsByTagName(n)]}},K=(i,t)=>{try{if(t.includes(":"))return new URL(i,t);const e="https://invalid.invalid/",r=new URL(i,e+t);return r.search="",decodeURI(r.href.replace(e,""))}catch(e){return console.warn(e),i}},Rt=i=>/^(?!blob)\w+:/i.test(i),Xt=(i,t)=>{if(!i)return t;const e=i.replace(/\/$/,"").split("/"),r=t.replace(/\/$/,"").split("/"),s=(e.length>r.length?e:r).findIndex((n,l)=>e[l]!==r[l]);return s<0?"":Array(e.length-s).fill("..").concat(r.slice(s)).join("/")},qt=i=>i.slice(0,i.lastIndexOf("/")+1),pt=async(i,t,e)=>{const r=[];i.replace(t,(...n)=>(r.push(n),null));const s=[];for(const n of r)s.push(await e(...n));return i.replace(t,()=>s.shift())},zt=i=>i.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),F={attrs:["dir","xml:lang"]},X={name:"alternate-script",many:!0,...F,props:["file-as"]},Ut={many:!0,...F,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",X],setLegacyAttrs:(i,t)=>{var e;if(!((e=i.role)!=null&&e.length)){const r=t.getAttributeNS(A.OPF,"role");r&&(i.role=[{value:r}])}i.fileAs??(i.fileAs=t.getAttributeNS(A.OPF,"file-as"))}},Vt=[{name:"title",many:!0,...F,props:["title-type","display-seq","file-as",X]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}],setLegacyAttrs:(i,t)=>{if(!i.identifierType){const e=t.getAttributeNS(A.OPF,"scheme");e&&(i.identifierType={value:e})}}},{name:"language",many:!0},{name:"creator",...Ut},{name:"contributor",...Ut},{name:"publisher",...F,props:["file-as",X]},{name:"description",...F,props:[X]},{name:"rights",...F,props:[X]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...F,props:["term","authority",X],setLegacyAttrs:(i,t)=>{i.term??(i.term=t.getAttributeNS(A.OPF,"term")),i.authority??(i.authority=t.getAttributeNS(A.OPF,"authority"))}},{name:"source",many:!0},{name:"belongs-to-collection",type:"meta",many:!0,...F,props:["collection-type","group-position","dcterms:identifier","file-as",X,{name:"belongs-to-collection",recursive:!0}]}],Gt=i=>{var t,e;const{$:r,$$:s}=nt(i,A.OPF),n=r(i.documentElement,"metadata"),l=Array.from(n.children),d=(v,c)=>{var p;if(!c)return null;const{props:C=[],attrs:x=[]}=v,E=$(c);if(!C.length&&!x.length)return E;const tt=c.getAttribute("id"),W=tt?l.filter(st("refines","#"+tt)):[],et=Object.fromEntries([["value",E]].concat(C.map(f=>{const{many:Mt,recursive:Ct}=f,it=typeof f=="string"?f:f.name,J=st("property",it),At=Ct?v:f;return[ut(it),Mt?W.filter(J).map(kt=>d(At,kt)):d(At,W.find(J))]})).concat(x.map(f=>[ut(f),c.getAttribute(f)])));return(p=v.setLegacyAttrs)==null||p.call(v,et,c),et},o=l.filter(st("refines",null)),h=Object.fromEntries(Vt.map(v=>{const{type:c,name:p,many:C}=v,x=c==="meta"?E=>E.namespaceURI===A.OPF&&E.getAttribute("property")===p:E=>E.namespaceURI===A.DC&&E.localName===p;return[ut(p),C?o.filter(x).map(E=>d(v,E)):d(v,o.find(x))]})),m=s(n,"meta"),u=v=>m.filter(st("property",c=>c?.startsWith(v))).map(c=>[c.getAttribute("property").replace(v,""),c]),y=Object.fromEntries(u("rendition:").map(([v,c])=>[v,$(c)])),b={narrator:[],duration:{}};for(const[v,c]of u("media:")){const p=$(c);v==="duration"?b.duration[((e=(t=c.getAttribute("refines"))==null?void 0:t.split("#"))==null?void 0:e[1])??""]=xt(p):v==="active-class"?b.activeClass=p:v==="narrator"?b.narrator.push(p):v==="playback-active-class"&&(b.playbackActiveClass=p)}return{metadata:h,rendition:y,media:b}},Jt=(i,t=e=>e)=>{var e;const{$:r,$$:s,$$$:n}=nt(i,A.XHTML),l=c=>c?decodeURI(t(c)):null,d=c=>p=>{var C;const x=r(p,"a")??r(p,"span"),E=r(p,"ol"),tt=l(x?.getAttribute("href")),W={label:$(x)||x?.getAttribute("title"),href:tt,subitems:o(E)};return c&&(W.type=(C=x?.getAttributeNS(A.EPUB,"type"))==null?void 0:C.split(/\s/)),W},o=(c,p)=>c?s(c,"li").map(d(p)):null,h=(c,p)=>o(r(c,"ol"),p),m=n(i,"nav");let u=null,y=null,b=null,v=[];for(const c of m){const p=((e=c.getAttributeNS(A.EPUB,"type"))==null?void 0:e.split(/\s/))??[];p.includes("toc")?u??(u=h(c)):p.includes("page-list")?y??(y=h(c)):p.includes("landmarks")?b??(b=h(c,!0)):v.push({label:$(c.firstElementChild),type:p,list:h(c)})}return{toc:u,pageList:y,landmarks:b,others:v}},Kt=(i,t=e=>e)=>{const{$:e,$$:r}=nt(i,A.NCX),s=o=>o?decodeURI(t(o)):null,n=o=>{const h=e(o,"navLabel"),m=e(o,"content"),u=$(h),y=s(m.getAttribute("src"));if(o.localName==="navPoint"){const b=r(o,"navPoint");return{label:u,href:y,subitems:b.length?b.map(n):null}}return{label:u,href:y}},l=(o,h)=>r(o,h).map(n),d=(o,h)=>{const m=e(i.documentElement,o);return m?l(m,h):null};return{toc:d("navMap","navPoint"),pageList:d("pageList","pageTarget"),others:r(i.documentElement,"navList").map(o=>({label:$(e(o,"navLabel")),list:l(o,"navTarget")}))}},xt=i=>{if(!i)return;const t=i.split(":").map(l=>parseFloat(l));if(t.length===3){const[l,d,o]=t;return l*60*60+d*60+o}if(t.length===2){const[l,d]=t;return l*60+d}const[e,r]=i.split(/(?=[^\d.])/),s=parseFloat(e),n=r==="h"?60*60:r==="min"?60:r==="ms"?.001:1;return s*n};var q,ft,Q,B,N,I,mt,gt,Lt,Ot,at,vt,z,Y,H,V,yt,It,lt,wt,_,G;class Qt extends EventTarget{constructor(t,e){super(),S(this,Lt),S(this,at),S(this,z),S(this,H),S(this,yt),S(this,lt),S(this,_),S(this,q,void 0),S(this,ft,void 0),S(this,Q,void 0),S(this,B,void 0),S(this,N,void 0),S(this,I,void 0),S(this,mt,1),S(this,gt,1),this.book=t,this.loadXML=e}async start(t,e=()=>!0){var r;(r=a(this,I))==null||r.pause();const s=this.book.sections[t],n=s?.id;if(!n)return;const{mediaOverlay:l}=s;if(!l)return this.start(t+1);T(this,Q,t),await w(this,Lt,Ot).call(this,l);for(let d=0;d<a(this,q).length;d++){const{items:o}=a(this,q)[d];for(let h=0;h<o.length;h++)if(o[h].text.split("#")[0]===n&&e(o[h],h,o))return w(this,_,G).call(this,d,h).catch(m=>w(this,H,V).call(this,m))}}pause(){var t;(t=a(this,I))==null||t.pause()}resume(){var t;(t=a(this,I))==null||t.play().catch(e=>w(this,H,V).call(this,e))}prev(){a(this,N)>0?w(this,_,G).call(this,a(this,B),a(this,N)-1):a(this,B)>0?w(this,_,G).call(this,a(this,B)-1,a(this,q)[a(this,B)-1].items.length-1):a(this,Q)>0&&this.start(a(this,Q)-1,(t,e,r)=>e===r.length-1)}next(){w(this,_,G).call(this,a(this,B),a(this,N)+1)}setVolume(t){T(this,mt,t),a(this,I)&&(a(this,I).volume=t)}setRate(t){T(this,gt,t),a(this,I)&&(a(this,I).playbackRate=t)}}q=new WeakMap,ft=new WeakMap,Q=new WeakMap,B=new WeakMap,N=new WeakMap,I=new WeakMap,mt=new WeakMap,gt=new WeakMap,Lt=new WeakSet,Ot=async function(i){if(a(this,ft)===i)return;const t=await this.loadXML(i.href),e=n=>n?K(n,i.href):null,{$:r,$$$:s}=nt(t,A.SMIL);T(this,B,-1),T(this,N,-1),T(this,q,s(t,"par").reduce((n,l)=>{var d;const o=e((d=r(l,"text"))==null?void 0:d.getAttribute("src")),h=r(l,"audio");if(!o||!h)return n;const m=e(h.getAttribute("src")),u=xt(h.getAttribute("clipBegin")),y=xt(h.getAttribute("clipEnd")),b=n.at(-1);return b?.src===m?b.items.push({text:o,begin:u,end:y}):n.push({src:m,items:[{text:o,begin:u,end:y}]}),n},[])),T(this,ft,i)},at=new WeakSet,vt=function(){return a(this,q)[a(this,B)]},z=new WeakSet,Y=function(){var i,t;return(t=(i=a(this,at,vt))==null?void 0:i.items)==null?void 0:t[a(this,N)]},H=new WeakSet,V=function(i){console.error(i),this.dispatchEvent(new CustomEvent("error",{detail:i}))},yt=new WeakSet,It=function(){this.dispatchEvent(new CustomEvent("highlight",{detail:a(this,z,Y)}))},lt=new WeakSet,wt=function(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:a(this,z,Y)}))},_=new WeakSet,G=async function(i,t){var e;a(this,I)&&(a(this,I).pause(),URL.revokeObjectURL(a(this,I).src),T(this,I,null)),T(this,B,i),T(this,N,t);const r=(e=a(this,at,vt))==null?void 0:e.src;if(!r||!a(this,z,Y))return this.start(a(this,Q)+1);const s=URL.createObjectURL(await this.book.loadBlob(r)),n=new Audio(s);T(this,I,n),n.addEventListener("timeupdate",()=>{var l,d;if(n.paused)return;const o=n.currentTime,{items:h}=a(this,at,vt);if(o>((l=a(this,z,Y))==null?void 0:l.end)&&(w(this,lt,wt).call(this),a(this,N)===h.length-1)){w(this,_,G).call(this,a(this,B)+1,0).catch(u=>w(this,H,V).call(this,u));return}const m=a(this,N);for(;((d=h[a(this,N)+1])==null?void 0:d.begin)<=o;)Dt(this,N)._++;a(this,N)!==m&&w(this,yt,It).call(this)}),n.addEventListener("error",()=>w(this,H,V).call(this,new Error(`Failed to load ${r}`))),n.addEventListener("playing",()=>w(this,yt,It).call(this)),n.addEventListener("pause",()=>w(this,lt,wt).call(this)),n.addEventListener("ended",()=>{w(this,lt,wt).call(this),URL.revokeObjectURL(s),T(this,I,null),w(this,_,G).call(this,i+1,0).catch(l=>w(this,H,V).call(this,l))}),n.addEventListener("canplaythrough",()=>{n.currentTime=a(this,z,Y).begin??0,n.volume=a(this,mt),n.playbackRate=a(this,gt),n.play().catch(l=>w(this,H,V).call(this,l))})};const Yt=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,Zt=i=>{for(const t of i.getElementsByTagNameNS(A.DC,"identifier")){const[e]=$(t).split(":").slice(-1);if(Yt.test(e))return e}return""},Pt=i=>$(i.getElementById(i.documentElement.getAttribute("unique-identifier"))??i.getElementsByTagNameNS(A.DC,"identifier")[0]),Wt=async(i,t,e)=>{const r=new Uint8Array(await e.slice(0,t).arrayBuffer());t=Math.min(t,r.length);for(var s=0;s<t;s++)r[s]=r[s]^i[s%i.length];return new Blob([r,e.slice(t)],{type:e.type})},te=async i=>{const t=new TextEncoder().encode(i),e=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(e)},ee=(i=te)=>({"http://www.idpf.org/2008/embedding":{key:t=>i(Pt(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(t,e)=>Wt(t,1040,e)},"http://ns.adobe.com/pdf/enc#RC":{key:t=>{const e=Zt(t).replaceAll("-","");return Uint8Array.from({length:16},(r,s)=>parseInt(e.slice(s*2,s*2+2),16))},decode:(t,e)=>Wt(t,1024,e)}});var bt,ot,St;class ie{constructor(t){S(this,bt,new Map),S(this,ot,new Map),S(this,St,void 0),T(this,St,t)}async init(t,e){if(!t)return;const r=Array.from(t.getElementsByTagNameNS(A.ENC,"EncryptedData"),s=>{var n,l;return{algorithm:(n=s.getElementsByTagNameNS(A.ENC,"EncryptionMethod")[0])==null?void 0:n.getAttribute("Algorithm"),uri:(l=s.getElementsByTagNameNS(A.ENC,"CipherReference")[0])==null?void 0:l.getAttribute("URI")}});for(const{algorithm:s,uri:n}of r){if(!a(this,ot).has(s)){const l=a(this,St)[s];if(!l){console.warn("Unknown encryption algorithm");continue}const d=await l.key(e);a(this,ot).set(s,o=>l.decode(d,o))}a(this,bt).set(n,s)}}getDecoder(t){return a(this,ot).get(a(this,bt).get(t))??(e=>e)}}bt=new WeakMap,ot=new WeakMap,St=new WeakMap;class re{constructor({opf:t,resolveHref:e}){var r,s,n,l,d;this.opf=t;const{$:o,$$:h,$$$:m}=nt(t,A.OPF),u=o(t.documentElement,"manifest"),y=o(t.documentElement,"spine"),b=h(y,"itemref");this.manifest=h(u,"item").map(dt("href","id","media-type","properties","media-overlay")).map(c=>{var p;return c.href=e(c.href),c.properties=(p=c.properties)==null?void 0:p.split(/\s/),c}),this.spine=b.map(dt("idref","id","linear","properties")).map(c=>{var p;return c.properties=(p=c.properties)==null?void 0:p.split(/\s/),c}),this.pageProgressionDirection=y.getAttribute("page-progression-direction"),this.navPath=(r=this.getItemByProperty("nav"))==null?void 0:r.href,this.ncxPath=(s=this.getItemByID(y.getAttribute("toc"))??this.manifest.find(c=>c.mediaType===L.NCX))==null?void 0:s.href;const v=o(t.documentElement,"guide");v&&(this.guide=h(v,"reference").map(dt("type","title","href")).map(({type:c,title:p,href:C})=>({label:p,type:c.split(/\s/),href:e(C)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID((n=m(t,"meta").find(st("name","cover")))==null?void 0:n.getAttribute("content"))??this.getItemByHref((d=(l=this.guide)==null?void 0:l.find(c=>c.type.includes("cover")))==null?void 0:d.href),this.cfis=(0,rt.f)(b)}getItemByID(t){return this.manifest.find(e=>e.id===t)}getItemByHref(t){return this.manifest.find(e=>e.href===t)}getItemByProperty(t){return this.manifest.find(e=>{var r;return(r=e.properties)==null?void 0:r.includes(t)})}resolveCFI(t){const e=(0,rt.p)(t),r=(e.parent??e).shift();let s=(0,rt.t)(this.opf,r);s&&s.nodeName!=="idref"&&(r.at(-1).id=null,s=(0,rt.t)(this.opf,r));const n=s?.getAttribute("idref");return{index:this.spine.findIndex(l=>l.idref===n),anchor:l=>(0,rt.a)(l,e)}}}var D,j,O;class se{constructor({loadText:t,loadBlob:e,resources:r}){S(this,D,new Map),S(this,j,new Map),S(this,O,new Map),Bt(this,"allowScript",!1),this.loadText=t,this.loadBlob=e,this.manifest=r.manifest,this.assets=r.manifest}createURL(t,e,r,s){if(!e)return"";const n=URL.createObjectURL(new Blob([e],{type:r}));if(a(this,D).set(t,n),a(this,O).set(t,1),s){const l=a(this,j).get(s);l?l.push(t):a(this,j).set(s,[t])}return n}ref(t,e){const r=a(this,j).get(e);return r!=null&&r.includes(t)||(a(this,O).set(t,a(this,O).get(t)+1),r?r.push(t):a(this,j).set(e,[t])),a(this,D).get(t)}unref(t){if(!a(this,O).has(t))return;const e=a(this,O).get(t)-1;if(e<1){URL.revokeObjectURL(a(this,D).get(t)),a(this,D).delete(t),a(this,O).delete(t);const r=a(this,j).get(t);if(r)for(;r.length;)this.unref(r.pop());a(this,j).delete(t)}else a(this,O).set(t,e)}async loadItem(t,e=[]){if(!t)return null;const{href:r,mediaType:s}=t,n=L.JS.test(t.mediaType);if(n&&!this.allowScript)return null;const l=e.at(-1);return a(this,D).has(r)?this.ref(r,l):(n||[L.XHTML,L.HTML,L.CSS,L.SVG].includes(s))&&e.every(d=>d!==r)?this.loadReplaced(t,e):this.createURL(r,await this.loadBlob(r),s,l)}async loadHref(t,e,r=[]){if(Rt(t))return t;const s=K(t,e),n=this.manifest.find(l=>l.href===s);return n?this.loadItem(n,r.concat(e)):t}async loadReplaced(t,e=[]){const{href:r,mediaType:s}=t,n=e.at(-1),l=await this.loadText(r);if(!l)return null;if([L.XHTML,L.HTML,L.SVG].includes(s)){let o=new DOMParser().parseFromString(l,s);if(s===L.XHTML&&o.querySelector("parsererror")&&(console.warn(o.querySelector("parsererror").innerText),t.mediaType=L.HTML,o=new DOMParser().parseFromString(l,t.mediaType)),[L.XHTML,L.SVG].includes(t.mediaType)){let u=o.firstChild;for(;u instanceof ProcessingInstruction;){if(u.data){const y=await pt(u.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(b,v,c,p)=>this.loadHref(c,r,e).then(C=>`${v}${C}${p}`));u.replaceWith(o.createProcessingInstruction(u.target,y))}u=u.nextSibling}}const h=async(u,y)=>u.setAttribute(y,await this.loadHref(u.getAttribute(y),r,e));for(const u of o.querySelectorAll("link[href]"))await h(u,"href");for(const u of o.querySelectorAll("[src]"))await h(u,"src");for(const u of o.querySelectorAll("[poster]"))await h(u,"poster");for(const u of o.querySelectorAll("object[data]"))await h(u,"data");for(const u of o.querySelectorAll("[*|href]:not([href])"))u.setAttributeNS(A.XLINK,"href",await this.loadHref(u.getAttributeNS(A.XLINK,"href"),r,e));for(const u of o.querySelectorAll("style"))u.textContent&&(u.textContent=await this.replaceCSS(u.textContent,r,e));for(const u of o.querySelectorAll("[style]"))u.setAttribute("style",await this.replaceCSS(u.getAttribute("style"),r,e));const m=new XMLSerializer().serializeToString(o);return this.createURL(r,m,t.mediaType,n)}const d=s===L.CSS?await this.replaceCSS(l,r,e):await this.replaceString(l,r,e);return this.createURL(r,d,s,n)}async replaceCSS(t,e,r=[]){const s=await pt(t,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(o,h)=>this.loadHref(h,e,r).then(m=>`url("${m}")`)),n=await pt(s,/@import\s*["']([^"'\n]*?)["']/gi,(o,h)=>this.loadHref(h,e,r).then(m=>`@import "${m}"`)),l=window?.innerWidth??800,d=window?.innerHeight??600;return n.replace(new RegExp("(?<=[{\\s;])-epub-","gi"),"").replace(/(\d*\.?\d+)vw/gi,(o,h)=>parseFloat(h)*l/100+"px").replace(/(\d*\.?\d+)vh/gi,(o,h)=>parseFloat(h)*d/100+"px").replace(/page-break-(after|before|inside)\s*:/gi,(o,h)=>`-webkit-column-break-${h}:`).replace(/break-(after|before|inside)\s*:\s*(avoid-)?page/gi,(o,h,m)=>`break-${h}: ${m??""}column`)}replaceString(t,e,r=[]){const s=new Map,n=this.assets.map(d=>{if(d.href===e)return;const o=Xt(qt(e),d.href),h=encodeURI(o),m="/"+d.href,u=encodeURI(m),y=new Set([o,h,m,u]);for(const b of y)s.set(b,d);return Array.from(y)}).flat().filter(d=>d);if(!n.length)return t;const l=new RegExp(n.map(zt).join("|"),"g");return pt(t,l,async d=>this.loadItem(s.get(d.replace(/^\//,"")),r.concat(e)))}unloadItem(t){this.unref(t?.href)}destroy(){for(const t of a(this,D).values())URL.revokeObjectURL(t)}}D=new WeakMap,j=new WeakMap,O=new WeakMap;const ne=(i,t)=>i.getElementById(t)??i.querySelector(`[name="${CSS.escape(t)}"]`),ae=i=>{for(const t of i){if(t==="page-spread-left"||t==="rendition:page-spread-left")return"left";if(t==="page-spread-right"||t==="rendition:page-spread-right")return"right";if(t==="rendition:page-spread-center")return"center"}},le=i=>i?{fixedLayout:$(i.querySelector('option[name="fixed-layout"]')),openToSpread:$(i.querySelector('option[name="open-to-spread"]'))}:null;var Z,ct,U,P;class oe{constructor({loadText:t,loadBlob:e,getSize:r,sha1:s}){S(this,U),Bt(this,"parser",new DOMParser),S(this,Z,void 0),S(this,ct,void 0),this.loadText=t,this.loadBlob=e,this.getSize=r,T(this,ct,new ie(ee(s)))}async init(){var t,e,r,s,n,l,d,o,h,m,u,y,b,v,c;const p=await w(this,U,P).call(this,"META-INF/container.xml");if(!p)throw new Error("Failed to load container file");const C=Array.from(p.getElementsByTagNameNS(A.CONTAINER,"rootfile"),dt("full-path","media-type")).filter(g=>g.mediaType==="application/oebps-package+xml");if(!C.length)throw new Error("No package document defined in container");const x=C[0].fullPath,E=await w(this,U,P).call(this,x);if(!E)throw new Error("Failed to load package document");const tt=await w(this,U,P).call(this,"META-INF/encryption.xml");await a(this,ct).init(tt,E),this.resources=new re({opf:E,resolveHref:g=>K(g,x)}),T(this,Z,new se({loadText:this.loadText,loadBlob:g=>Promise.resolve(this.loadBlob(g)).then(a(this,ct).getDecoder(g)),resources:this.resources})),this.sections=this.resources.spine.map((g,k)=>{const{idref:M,linear:ht,properties:Nt=[]}=g,R=this.resources.getItemByID(M);return R?{id:R.href,load:()=>a(this,Z).loadItem(R),unload:()=>a(this,Z).unloadItem(R),createDocument:()=>this.loadDocument(R),size:this.getSize(R.href),cfi:this.resources.cfis[k],linear:ht,pageSpread:ae(Nt),resolveHref:Et=>K(Et,R.href),mediaOverlay:R.mediaOverlay?this.resources.getItemByID(R.mediaOverlay):null}:(console.warn(`Could not find item with ID "${M}" in manifest`),null)}).filter(g=>g);const{navPath:W,ncxPath:et}=this.resources;if(W)try{const g=M=>K(M,W),k=Jt(await w(this,U,P).call(this,W),g);this.toc=k.toc,this.pageList=k.pageList,this.landmarks=k.landmarks}catch(g){console.warn(g)}if(!this.toc&&et)try{const g=M=>K(M,et),k=Kt(await w(this,U,P).call(this,et),g);this.toc=k.toc,this.pageList=k.pageList}catch(g){console.warn(g)}this.landmarks??(this.landmarks=this.resources.guide);const{metadata:f,rendition:Mt,media:Ct}=Gt(E);this.rendition=Mt,this.media=Ct,this.dir=this.resources.pageProgressionDirection;const it=le(await w(this,U,P).call(this,"META-INF/com.apple.ibooks.display-options.xml")??await w(this,U,P).call(this,"META-INF/com.kobobooks.display-options.xml"));it&&(it.fixedLayout==="true"&&((t=this.rendition).layout??(t.layout="pre-paginated")),it.openToSpread==="false"&&((e=this.sections.find(g=>g.linear!=="no")).pageSpread??(e.pageSpread=this.dir==="rtl"?"left":"right"))),this.parsedMetadata=f;const J=(r=f?.title)==null?void 0:r[0];this.metadata={title:J?.value,subtitle:(n=(s=f?.title)==null?void 0:s.find(g=>g.titleType==="subtitle"))==null?void 0:n.value,sortAs:J?.fileAs,language:f?.language,identifier:Pt(E),description:(l=f?.description)==null?void 0:l.value,publisher:(d=f?.publisher)==null?void 0:d.value,published:f?.date,modified:f?.dctermsModified,subject:(h=(o=f?.subject)==null?void 0:o.filter(({value:g,term:k})=>g||k))==null?void 0:h.map(({value:g,term:k,authority:M})=>({name:g,code:k,scheme:M})),rights:(m=f?.rights)==null?void 0:m.value};const At={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},kt=g=>k=>{var M;const ht=[...new Set((M=k.role)==null?void 0:M.map(({value:R,scheme:Et})=>(!Et||Et==="marc:relators"?At[R]:null)??g))],Nt={name:k.value,sortAs:k.fileAs};return[ht!=null&&ht.length?ht:[g],Nt]};return(c=(v=(u=f?.creator)==null?void 0:u.map(kt("author")))==null?void 0:v.concat((b=(y=f?.contributor)==null?void 0:y.map)==null?void 0:b.call(y,kt("contributor"))))==null||c.forEach(([g,k])=>g.forEach(M=>{this.metadata[M]?this.metadata[M].push(k):this.metadata[M]=[k]})),this}async loadDocument(t){const e=await this.loadText(t.href);return this.parser.parseFromString(e,t.mediaType)}getMediaOverlay(){return new Qt(this,w(this,U,P).bind(this))}resolveCFI(t){return this.resources.resolveCFI(t)}resolveHref(t){const[e,r]=t.split("#"),s=this.resources.getItemByHref(decodeURI(e));return s?{index:this.resources.spine.findIndex(({idref:n})=>n===s.id),anchor:r?n=>ne(n,r):()=>0}:null}splitTOCHref(t){return t?.split("#")??[]}getTOCFragment(t,e){return t.getElementById(e)??t.querySelector(`[name="${CSS.escape(e)}"]`)}isExternal(t){return Rt(t)}async getCover(){var t;const e=(t=this.resources)==null?void 0:t.cover;return e!=null&&e.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const t=await this.loadText("META-INF/calibre_bookmarks.txt"),e="encoding=json+base64:";if(t!=null&&t.startsWith(e)){const r=atob(t.slice(e.length));return JSON.parse(r)}}destroy(){var t;(t=a(this,Z))==null||t.destroy()}}Z=new WeakMap,ct=new WeakMap,U=new WeakSet,P=async function(i){const t=await this.loadText(i);if(!t)return null;const e=this.parser.parseFromString(t,L.XML);if(e.querySelector("parsererror"))throw new Error(`XML parsing error: ${i}
${e.querySelector("parsererror").innerText}`);return e}}}]);
