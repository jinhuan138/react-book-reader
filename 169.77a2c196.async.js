!(function(){"use strict";var ae=Object.defineProperty;var Tt=p=>{throw TypeError(p)};var ce=(p,m,f)=>m in p?ae(p,m,{enumerable:!0,configurable:!0,writable:!0,value:f}):p[m]=f;var Y=(p,m,f)=>ce(p,typeof m!="symbol"?m+"":m,f),ot=(p,m,f)=>m.has(p)||Tt("Cannot "+f);var d=(p,m,f)=>(ot(p,m,"read from private field"),f?f.call(p):m.get(p)),v=(p,m,f)=>m.has(p)?Tt("Cannot add the same private member more than once"):m instanceof WeakSet?m.add(p):m.set(p,f),b=(p,m,f,M)=>(ot(p,m,"write to private field"),M?M.call(p,f):m.set(p,f),f),w=(p,m,f)=>(ot(p,m,"access private method"),f);var Ct=(p,m,f,M)=>({set _(k){b(p,m,k,f)},get _(){return d(p,m,M)}});(self.webpackChunkreact_book_reader_docs=self.webpackChunkreact_book_reader_docs||[]).push([[169],{44169:function(p,m,f){var K,Ft,S,I,B,O,j,E,T,A,G,N,F,$,P,X,y,z,St,It,Lt,Z,Nt,Pt,zt;f.r(m),f.d(m,{a:function(){return ft},f:function(){return Ht},p:function(){return W},t:function(){return Ut},v:function(){return re}});const M=(n,i)=>n.map((t,e,s)=>i(t,e,s)?e:null).filter(t=>t!=null),k=(n,i)=>[-1,...i,n.length].reduce(({xs:t,a:e},s)=>({xs:t?.concat([n.slice(e+1,s)])??[],a:s}),{}).xs,$t=(n,i)=>n.slice(0,-1).concat([n[n.length-1].concat(i[0])]).concat(i.slice(1)),Q=/\d/,H=/^epubcfi\((.*)\)$/,rt=n=>n.replace(/[\^[\](),;=]/g,"^$&"),at=n=>H.test(n)?n:`epubcfi(${n})`,Ot=n=>n.match(H)?.[1]??n,Mt=n=>(...i)=>`epubcfi(${n(...i.map(t=>t.match(H)?.[1]??t))})`,Rt=Mt((...n)=>n.join("!")),Bt=n=>{const i=[];let t,e,s="";const r=o=>(i.push(o),t=null,s=""),a=o=>(s+=o,e=!1);for(const o of Array.from(n.trim()).concat("")){if(o==="^"&&!e){e=!0;continue}if(t==="!")r(["!"]);else if(t===",")r([","]);else if(t==="/"||t===":")if(Q.test(o)){a(o);continue}else r([t,parseInt(s)]);else if(t==="~")if(Q.test(o)||o==="."){a(o);continue}else r(["~",parseFloat(s)]);else if(t==="@"){if(o===":"){r(["@",parseFloat(s)]),t="@";continue}if(Q.test(o)||o==="."){a(o);continue}else r(["@",parseFloat(s)])}else if(t==="["){o===";"&&!e?(r(["[",s]),t=";"):o===","&&!e?(r(["[",s]),t="["):o==="]"&&!e?r(["[",s]):a(o);continue}else if(t?.startsWith(";")){o==="="&&!e?(t=`;${s}`,s=""):o===";"&&!e?(r([t,s]),t=";"):o==="]"&&!e?r([t,s]):a(o);continue}(o==="/"||o===":"||o==="~"||o==="@"||o==="["||o==="!"||o===",")&&(t=o)}return i},ct=(n,i)=>M(n,([t])=>t===i),Wt=n=>{const i=[];let t;for(const[e,s]of n){if(e==="/")i.push({index:s});else{const r=i[i.length-1];if(e===":")r.offset=s;else if(e==="~")r.temporal=s;else if(e==="@")r.spatial=(r.spatial??[]).concat(s);else if(e===";s")r.side=s;else if(e==="[")if(t==="/"&&s)r.id=s;else{r.text=(r.text??[]).concat(s);continue}}t=e}return i},ht=n=>k(n,ct(n,"!")).map(Wt),W=n=>{const i=Bt(Ot(n)),t=ct(i,",");if(!t.length)return ht(i);const[e,s,r]=k(i,t).map(ht);return{parent:e,start:s,end:r}},Dt=({index:n,id:i,offset:t,temporal:e,spatial:s,text:r,side:a})=>{const o=a?`;s=${a}`:"";return`/${n}`+(i?`[${rt(i)}${o}]`:"")+(t!=null&&n%2?`:${t}`:"")+(e?`~${e}`:"")+(s?`@${s.join(":")}`:"")+(r||!i&&a?"["+(r?.map(rt)?.join(",")??"")+o+"]":"")},lt=n=>n.parent?[n.parent,n.start,n.end].map(lt).join(","):n.map(i=>i.map(Dt).join("")).join("!"),U=n=>at(lt(n)),R=(n,i)=>typeof n=="string"?U(R(W(n),i)):n.parent?$t(n.parent,n[i?"end":"start"]):n,jt=(n,i)=>{typeof n=="string"&&(n=W(n)),typeof i=="string"&&(i=W(i)),n=R(n),i=R(i,!0);const t=n[n.length-1],e=i[i.length-1],s=[],r=[],a=[];let o=!0;const l=Math.max(t.length,e.length);for(let h=0;h<l;h++){const u=t[h],g=e[h];o&&(o=u?.index===g?.index&&!u?.offset&&!g?.offset),o?s.push(u):(u&&r.push(u),g&&a.push(g))}const c=n.slice(0,-1).concat([s]);return U({parent:c,start:[r],end:[a]})},q=({nodeType:n})=>n===3||n===4,V=({nodeType:n})=>n===1,dt=(n,i)=>{const t=Array.from(n.childNodes).filter(e=>q(e)||V(e));return i?t.map(e=>{const s=i(e);return s===NodeFilter.FILTER_REJECT?null:s===NodeFilter.FILTER_SKIP?dt(e,i):e}).flat().filter(e=>e):t},_=(n,i)=>{const t=dt(n,i).reduce((e,s)=>{let r=e[e.length-1];return r?q(s)?Array.isArray(r)?r.push(s):q(r)?e[e.length-1]=[r,s]:e.push(s):V(r)?e.push(null,s):e.push(s):e.push(s),e},[]);return V(t[0])&&t.unshift("first"),V(t[t.length-1])&&t.push("last"),t.unshift("before"),t.push("after"),t},tt=(n,i,t)=>{const{id:e}=i[i.length-1];if(e){const a=n.ownerDocument.getElementById(e);if(a)return{node:a,offset:0}}for(const{index:a}of i){const o=n?_(n,t)[a]:null;if(o==="first")return{node:n.firstChild??n};if(o==="last")return{node:n.lastChild??n};if(o==="before")return{node:n,before:!0};if(o==="after")return{node:n,after:!0};n=o}const{offset:s}=i[i.length-1];if(!Array.isArray(n))return{node:n,offset:s};let r=0;for(const a of n){const{length:o}=a.nodeValue;if(r+o>=s)return{node:a,offset:s-r};r+=o}},J=(n,i,t)=>{const{parentNode:e,id:s}=n,r=_(e,t),a=r.findIndex(c=>Array.isArray(c)?c.some(h=>h===n):c===n),o=r[a];if(Array.isArray(o)){let c=0;for(const h of o)if(h===n){c+=i;break}else c+=h.nodeValue.length;i=c}const l={id:s,index:a,offset:i};return(e!==n.ownerDocument.documentElement?J(e,null,t).concat(l):[l]).filter(c=>c.index!==-1)},kt=(n,i)=>{const{startContainer:t,startOffset:e,endContainer:s,endOffset:r}=n,a=J(t,e,i);if(n.collapsed)return U([a]);const o=J(s,r,i);return jt([a],[o])},ft=(n,i,t)=>{const e=R(i),s=R(i,!0),r=n.documentElement,a=tt(r,e[0],t),o=tt(r,s[0],t),l=n.createRange();return a.before?l.setStartBefore(a.node):a.after?l.setStartAfter(a.node):l.setStart(a.node,a.offset),o.before?l.setEndBefore(o.node):o.after?l.setEndAfter(o.node):l.setEnd(o.node,o.offset),l},Ht=n=>{const i=[],{parentNode:t}=n[0],e=J(t);for(const[s,r]of _(t).entries()){const a=n[i.length];r===a&&i.push(U([e.concat({id:a.id,index:s})]))}return i},Ut=(n,i)=>tt(n.documentElement,R(i)).node,ut={fromIndex:n=>at(`/6/${(n+1)*2}`),toIndex:n=>n?.at(-1).index/2-1},Vt=n=>{let i=0;const t=e=>{if(e.id=i++,e.subitems)for(const s of e.subitems)t(s)};for(const e of n)t(e);return n},gt=n=>n.map(i=>i.subitems?.length?[i,gt(i.subitems)].flat():i).flat();class mt{async init({toc:i,ids:t,splitHref:e,getFragment:s}){Vt(i);const r=gt(i),a=new Map;for(const[l,c]of r.entries()){const[h,u]=await e(c?.href)??[],g={fragment:u,item:c};a.has(h)?a.get(h).items.push(g):a.set(h,{prev:r[l-1],items:[g]})}const o=new Map;for(const[l,c]of t.entries())a.has(c)?o.set(c,a.get(c)):o.set(c,o.get(t[l-1]));this.ids=t,this.map=o,this.getFragment=s}getProgress(i,t){if(!this.ids)return;const e=this.ids[i],s=this.map.get(e);if(!s)return null;const{prev:r,items:a}=s;if(!a)return r;if(!t||a.length===1&&!a[0].fragment)return a[0].item;const o=t.startContainer.getRootNode();for(const[l,{fragment:c}]of a.entries()){const h=this.getFragment(o,c);if(h&&t.comparePoint(h,0)>0)return a[l-1]?.item??r}return a[a.length-1].item}}class Jt{constructor(i,t,e){v(this,K);this.sizes=i.map(s=>s.linear!="no"&&s.size>0?s.size:0),this.sizePerLoc=t,this.sizePerTimeUnit=e,this.sizeTotal=this.sizes.reduce((s,r)=>s+r,0),this.sectionFractions=w(this,K,Ft).call(this)}getProgress(i,t,e=0){const{sizes:s,sizePerLoc:r,sizePerTimeUnit:a,sizeTotal:o}=this,l=s[i]??0,c=s.slice(0,i).reduce((C,L)=>C+L,0)+t*l,h=c+e*l,u=o-c,g=(1-t)*l;return{fraction:h/o,section:{current:i,total:s.length},location:{current:Math.floor(c/r),next:Math.floor(h/r),total:Math.ceil(o/r)},time:{section:g/a,total:u/a}}}getSection(i){if(i<=0)return[0,0];if(i>=1)return[this.sizes.length-1,1];i=i+Number.EPSILON;const{sizeTotal:t}=this;let e=this.sectionFractions.findIndex(r=>r>i)-1;if(e<0)return[0,0];for(;!this.sizes[e];)e++;const s=(i-this.sectionFractions[e])/(this.sizes[e]/t);return[e,s]}}K=new WeakSet,Ft=function(){const{sizeTotal:i}=this,t=[0];let e=0;for(const s of this.sizes)t.push((e+=s)/i);return t};const x=n=>document.createElementNS("http://www.w3.org/2000/svg",n);class pt{constructor(){v(this,S,x("svg"));v(this,I,new Map);Object.assign(d(this,S).style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"})}get element(){return d(this,S)}add(i,t,e,s){d(this,I).has(i)&&this.remove(i),typeof t=="function"&&(t=t(d(this,S).getRootNode()));const r=t.getClientRects(),a=e(r,s);d(this,S).append(a),d(this,I).set(i,{range:t,draw:e,options:s,element:a,rects:r})}remove(i){d(this,I).has(i)&&(d(this,S).removeChild(d(this,I).get(i).element),d(this,I).delete(i))}redraw(){for(const i of d(this,I).values()){const{range:t,draw:e,options:s,element:r}=i;d(this,S).removeChild(r);const a=t.getClientRects(),o=e(a,s);d(this,S).append(o),i.element=o,i.rects=a}}hitTest({x:i,y:t}){const e=Array.from(d(this,I).entries());for(let s=e.length-1;s>=0;s--){const[r,a]=e[s];for(const{left:o,top:l,right:c,bottom:h}of a.rects)if(l<=t&&o<=i&&h>t&&c>i)return[r,a.range]}return[]}static underline(i,t={}){const{color:e="red",width:s=2,writingMode:r}=t,a=x("g");if(a.setAttribute("fill",e),r==="vertical-rl"||r==="vertical-lr")for(const{right:o,top:l,height:c}of i){const h=x("rect");h.setAttribute("x",o-s),h.setAttribute("y",l),h.setAttribute("height",c),h.setAttribute("width",s),a.append(h)}else for(const{left:o,bottom:l,width:c}of i){const h=x("rect");h.setAttribute("x",o),h.setAttribute("y",l-s),h.setAttribute("height",s),h.setAttribute("width",c),a.append(h)}return a}static strikethrough(i,t={}){const{color:e="red",width:s=2,writingMode:r}=t,a=x("g");if(a.setAttribute("fill",e),r==="vertical-rl"||r==="vertical-lr")for(const{right:o,left:l,top:c,height:h}of i){const u=x("rect");u.setAttribute("x",(o+l)/2),u.setAttribute("y",c),u.setAttribute("height",h),u.setAttribute("width",s),a.append(u)}else for(const{left:o,top:l,bottom:c,width:h}of i){const u=x("rect");u.setAttribute("x",o),u.setAttribute("y",(l+c)/2),u.setAttribute("height",s),u.setAttribute("width",h),a.append(u)}return a}static squiggly(i,t={}){const{color:e="red",width:s=2,writingMode:r}=t,a=x("g");a.setAttribute("fill","none"),a.setAttribute("stroke",e),a.setAttribute("stroke-width",s);const o=s*1.5;if(r==="vertical-rl"||r==="vertical-lr")for(const{right:l,top:c,height:h}of i){const u=x("path"),g=Math.round(h/o/1.5),C=h/g,L=Array.from({length:g},(it,nt)=>`l${nt%2?-o:o} ${C}`).join("");u.setAttribute("d",`M${l} ${c}${L}`),a.append(u)}else for(const{left:l,bottom:c,width:h}of i){const u=x("path"),g=Math.round(h/o/1.5),C=h/g,L=Array.from({length:g},(it,nt)=>`l${C} ${nt%2?o:-o}`).join("");u.setAttribute("d",`M${l} ${c}${L}`),a.append(u)}return a}static highlight(i,t={}){const{color:e="red"}=t,s=x("g");s.setAttribute("fill",e),s.style.opacity="var(--overlayer-highlight-opacity, .3)",s.style.mixBlendMode="var(--overlayer-highlight-blend-mode, normal)";for(const{left:r,top:a,height:o,width:l}of i){const c=x("rect");c.setAttribute("x",r),c.setAttribute("y",a),c.setAttribute("height",o),c.setAttribute("width",l),s.append(c)}return s}static outline(i,t={}){const{color:e="red",width:s=3,radius:r=3}=t,a=x("g");a.setAttribute("fill","none"),a.setAttribute("stroke",e),a.setAttribute("stroke-width",s);for(const{left:o,top:l,height:c,width:h}of i){const u=x("rect");u.setAttribute("x",o),u.setAttribute("y",l),u.setAttribute("height",c),u.setAttribute("width",h),u.setAttribute("rx",r),a.append(u)}return a}static copyImage([i],t={}){const{src:e}=t,s=x("image"),{left:r,top:a,height:o,width:l}=i;return s.setAttribute("href",e),s.setAttribute("x",r),s.setAttribute("y",a),s.setAttribute("height",o),s.setAttribute("width",l),s}}S=new WeakMap,I=new WeakMap;const Kt=(n,i)=>{const t=[];for(let e=i.currentNode;e;e=i.nextNode()){const s=n.comparePoint(e,0);if(s===0)t.push(e);else if(s>0)break}return t},Gt=(n,i)=>{const t=[];for(let e=i.nextNode();e;e=i.nextNode())t.push(e);return t},Xt=NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_CDATA_SECTION,Yt=n=>{if(n.nodeType===1){const i=n.tagName.toLowerCase();return i==="script"||i==="style"?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_SKIP}return NodeFilter.FILTER_ACCEPT},yt=function*(n,i,t){const e=n.commonAncestorContainer??n.body??n,s=document.createTreeWalker(e,Xt,{acceptNode:t||Yt}),r=(n.commonAncestorContainer?Kt:Gt)(n,s),a=r.map(l=>l.nodeValue),o=(l,c,h,u)=>{const g=document.createRange();return g.setStart(r[l],c),g.setEnd(r[h],u),g};for(const l of i(a,o))yield l},D="foliate-search:",Zt=async n=>{const i=new Uint8Array(await n.slice(0,4).arrayBuffer());return i[0]===80&&i[1]===75&&i[2]===3&&i[3]===4},Qt=async n=>{const i=new Uint8Array(await n.slice(0,5).arrayBuffer());return i[0]===37&&i[1]===80&&i[2]===68&&i[3]===70&&i[4]===45},qt=({name:n,type:i})=>i==="application/vnd.comicbook+zip"||n.endsWith(".cbz"),_t=({name:n,type:i})=>i==="application/x-fictionbook+xml"||n.endsWith(".fb2"),te=({name:n,type:i})=>i==="application/x-zip-compressed-fb2"||n.endsWith(".fb2.zip")||n.endsWith(".fbz"),ee=async n=>{const{configure:i,ZipReader:t,BlobReader:e,TextWriter:s,BlobWriter:r}=await f.e(84).then(f.bind(f,79084));i({useWebWorkers:!1});const a=await new t(new e(n)).getEntries(),o=new Map(a.map(u=>[u.filename,u])),l=u=>(g,...C)=>o.has(g)?u(o.get(g),...C):null,c=l(u=>u.getData(new s)),h=l((u,g)=>u.getData(new r(g)));return{entries:a,loadText:c,loadBlob:h,getSize:u=>o.get(u)?.uncompressedSize??0}},wt=async n=>n.isFile?n:(await Promise.all(Array.from(await new Promise((i,t)=>n.createReader().readEntries(e=>i(e),e=>t(e))),wt))).flat(),se=async n=>{const i=await wt(n),t=await Promise.all(i.map(o=>new Promise((l,c)=>o.file(h=>l([h,o.fullPath]),h=>c(h))))),e=new Map(t.map(([o,l])=>[l.replace(n.fullPath+"/",""),o])),s=new TextDecoder,r=o=>o?s.decode(o):null,a=o=>e.get(o)?.arrayBuffer()??null;return{loadText:async o=>r(await a(o)),loadBlob:o=>e.get(o),getSize:o=>e.get(o)?.size??0}};class vt extends Error{}class bt extends Error{}class xt extends Error{}const ie=async n=>{const i=await fetch(n);if(!i.ok)throw new vt(`${i.status} ${i.statusText}`,{cause:i});return new File([await i.blob()],new URL(i.url).pathname)},At=async n=>{typeof n=="string"&&(n=await ie(n));let i;if(n.isDirectory){const t=await se(n),{EPUB:e}=await f.e(535).then(f.bind(f,22535));i=await new e(t).init()}else if(n.size)if(await Zt(n)){const t=await ee(n);if(qt(n)){const{makeComicBook:e}=await f.e(396).then(f.bind(f,16396));i=e(t,n)}else if(te(n)){const{makeFB2:e}=await f.e(645).then(f.bind(f,3645)),{entries:s}=t,r=s.find(o=>o.filename.endsWith(".fb2")),a=await t.loadBlob((r??s[0]).filename);i=await e(a)}else{const{EPUB:e}=await f.e(535).then(f.bind(f,22535));i=await new e(t).init()}}else if(await Qt(n)){const{makePDF:t}=await f.e(445).then(f.bind(f,94445));i=await t(n)}else{const{isMOBI:t,MOBI:e}=await f.e(453).then(f.bind(f,50453));if(await t(n)){const s=await f.e(484).then(f.bind(f,31484));i=await new e({unzlib:s.unzlibSync}).open(n)}else if(_t(n)){const{makeFB2:s}=await f.e(645).then(f.bind(f,3645));i=await s(n)}}else throw new bt("File not found");if(!i)throw new xt("File type not supported");return i},st=class st{constructor(i,t,e={}){v(this,B);v(this,O);v(this,j);v(this,E);b(this,O,i),b(this,j,t),b(this,E,e),d(this,E).hidden&&this.hide(),d(this,O).addEventListener("mousemove",({screenX:s,screenY:r})=>{s===d(this,E).x&&r===d(this,E).y||(d(this,E).x=s,d(this,E).y=r,this.show(),d(this,B)&&clearTimeout(d(this,B)),t()&&b(this,B,setTimeout(this.hide.bind(this),1e3)))},!1)}cloneFor(i){return new st(i,d(this,j),d(this,E))}hide(){d(this,O).style.cursor="none",d(this,E).hidden=!0}show(){d(this,O).style.removeProperty("cursor"),d(this,E).hidden=!1}};B=new WeakMap,O=new WeakMap,j=new WeakMap,E=new WeakMap;let et=st;class ne extends EventTarget{constructor(){super(...arguments);v(this,T,[]);v(this,A,-1)}pushState(t){const e=d(this,T)[d(this,A)];e===t||e?.fraction&&e.fraction===t.fraction||(d(this,T)[++Ct(this,A)._]=t,d(this,T).length=d(this,A)+1,this.dispatchEvent(new Event("index-change")))}replaceState(t){const e=d(this,A);d(this,T)[e]=t}back(){const t=d(this,A);if(t<=0)return;const e={state:d(this,T)[t-1]};b(this,A,t-1),this.dispatchEvent(new CustomEvent("popstate",{detail:e})),this.dispatchEvent(new Event("index-change"))}forward(){const t=d(this,A);if(t>=d(this,T).length-1)return;const e={state:d(this,T)[t+1]};b(this,A,t+1),this.dispatchEvent(new CustomEvent("popstate",{detail:e})),this.dispatchEvent(new Event("index-change"))}get canGoBack(){return d(this,A)>0}get canGoForward(){return d(this,A)<d(this,T).length-1}clear(){b(this,T,[]),b(this,A,-1)}}T=new WeakMap,A=new WeakMap;const oe=n=>{if(!n)return{};try{const i=Intl.getCanonicalLocales(n)[0],t=new Intl.Locale(i),e=["zh","ja","kr"].includes(t.language),s=(t.getTextInfo?.()??t.textInfo)?.direction;return{canonical:i,locale:t,isCJK:e,direction:s}}catch(i){return console.warn(i),{}}};class Et extends HTMLElement{constructor(){super();v(this,y);v(this,G,this.attachShadow({mode:"closed"}));v(this,N);v(this,F);v(this,$);v(this,P,new Map);v(this,X,new et(this,()=>this.hasAttribute("autohide-cursor")));Y(this,"isFixedLayout",!1);Y(this,"lastLocation");Y(this,"history",new ne);this.history.addEventListener("popstate",({detail:t})=>{const e=this.resolveNavigation(t.state);this.renderer.goTo(e)})}async open(t){if((typeof t=="string"||typeof t.arrayBuffer=="function"||t.isDirectory)&&(t=await At(t)),this.book=t,this.language=oe(t.metadata?.language),t.splitTOCHref&&t.getTOCFragment){const e=t.sections.map(a=>a.id);b(this,N,new Jt(t.sections,1500,1600));const s=t.splitTOCHref.bind(t),r=t.getTOCFragment.bind(t);b(this,F,new mt),await d(this,F).init({toc:t.toc??[],ids:e,splitHref:s,getFragment:r}),b(this,$,new mt),await d(this,$).init({toc:t.pageList??[],ids:e,splitHref:s,getFragment:r})}if(this.isFixedLayout=this.book.rendition?.layout==="pre-paginated",this.isFixedLayout?(await f.e(153).then(f.bind(f,83153)),this.renderer=document.createElement("foliate-fxl")):(await f.e(628).then(f.bind(f,53628)),this.renderer=document.createElement("foliate-paginator")),this.renderer.setAttribute("exportparts","head,foot,filter"),this.renderer.addEventListener("load",e=>w(this,y,It).call(this,e.detail)),this.renderer.addEventListener("relocate",e=>w(this,y,St).call(this,e.detail)),this.renderer.addEventListener("create-overlayer",e=>e.detail.attach(w(this,y,Nt).call(this,e.detail))),this.renderer.open(t),d(this,G).append(this.renderer),t.sections.some(e=>e.mediaOverlay)){const e=t.media.activeClass,s=t.media.playbackActiveClass;this.mediaOverlay=t.getMediaOverlay();let r;this.mediaOverlay.addEventListener("highlight",a=>{const o=this.resolveNavigation(a.detail.text);this.renderer.goTo(o).then(()=>{const{doc:l}=this.renderer.getContents().find(h=>h.index=o.index),c=o.anchor(l);c.classList.add(e),s&&c.ownerDocument.documentElement.classList.add(s),r=new WeakRef(c)})}),this.mediaOverlay.addEventListener("unhighlight",()=>{const a=r?.deref();a&&(a.classList.remove(e),s&&a.ownerDocument.documentElement.classList.remove(s))})}}close(){this.renderer?.destroy(),this.renderer?.remove(),b(this,N,null),b(this,F,null),b(this,$,null),b(this,P,new Map),this.lastLocation=null,this.history.clear(),this.tts=null,this.mediaOverlay=null}goToTextStart(){return this.goTo(this.book.landmarks?.find(t=>t.type.includes("bodymatter")||t.type.includes("text"))?.href??this.book.sections.findIndex(t=>t.linear!=="no"))}async init({lastLocation:t,showTextStart:e}){const s=t?this.resolveNavigation(t):null;s?(await this.renderer.goTo(s),this.history.pushState(t)):e?await this.goToTextStart():(this.history.pushState(0),await this.next())}async addAnnotation(t,e){const{value:s}=t;if(s.startsWith(D)){const c=s.replace(D,""),{index:h,anchor:u}=await this.resolveNavigation(c),g=w(this,y,Z).call(this,h);if(g){const{overlayer:C,doc:L}=g;if(e){C.remove(s);return}const it=L?u(L):u;C.add(s,it,pt.outline)}return}const{index:r,anchor:a}=await this.resolveNavigation(s),o=w(this,y,Z).call(this,r);if(o){const{overlayer:c,doc:h}=o;if(c.remove(s),!e){const u=h?a(h):a,g=(C,L)=>c.add(s,u,C,L);w(this,y,z).call(this,"draw-annotation",{draw:g,annotation:t,doc:h,range:u})}}const l=d(this,F).getProgress(r)?.label??"";return{index:r,label:l}}deleteAnnotation(t){return this.addAnnotation(t,!0)}async showAnnotation(t){const{value:e}=t,s=await this.goTo(e);if(s){const{index:r,anchor:a}=s,{doc:o}=w(this,y,Z).call(this,r),l=a(o);w(this,y,z).call(this,"show-annotation",{value:e,index:r,range:l})}}getCFI(t,e){const s=this.book.sections[t].cfi??ut.fromIndex(t);return e?Rt(s,kt(e)):s}resolveCFI(t){if(this.book.resolveCFI)return this.book.resolveCFI(t);{const e=W(t);return{index:ut.toIndex((e.parent??e).shift()),anchor:s=>ft(s,e)}}}resolveNavigation(t){try{if(typeof t=="number")return{index:t};if(typeof t.fraction=="number"){const[e,s]=d(this,N).getSection(t.fraction);return{index:e,anchor:s}}return H.test(t)?this.resolveCFI(t):this.book.resolveHref(t)}catch(e){console.error(e),console.error(`Could not resolve target ${t}`)}}async goTo(t){const e=this.resolveNavigation(t);try{return await this.renderer.goTo(e),this.history.pushState(t),e}catch(s){console.error(s),console.error(`Could not go to ${t}`)}}async goToFraction(t){const[e,s]=d(this,N).getSection(t);await this.renderer.goTo({index:e,anchor:s}),this.history.pushState({fraction:t})}async select(t){try{const e=await this.resolveNavigation(t);await this.renderer.goTo({...e,select:!0}),this.history.pushState(t)}catch(e){console.error(e),console.error(`Could not go to ${t}`)}}deselect(){for(const{doc:t}of this.renderer.getContents())t.defaultView.getSelection().removeAllRanges()}getSectionFractions(){return(d(this,N)?.sectionFractions??[]).map(t=>t+Number.EPSILON)}getProgressOf(t,e){const s=d(this,F)?.getProgress(t,e),r=d(this,$)?.getProgress(t,e);return{tocItem:s,pageItem:r}}async getTOCItemOf(t){try{const{index:e,anchor:s}=await this.resolveNavigation(t),r=await this.book.sections[e].createDocument(),a=s(r),o=a instanceof Range,l=o?a:r.createRange();return o||l.selectNodeContents(a),d(this,F).getProgress(e,l)}catch(e){console.error(e),console.error(`Could not get ${t}`)}}async prev(t){await this.renderer.prev(t)}async next(t){await this.renderer.next(t)}goLeft(){return this.book.dir==="rtl"?this.next():this.prev()}goRight(){return this.book.dir==="rtl"?this.prev():this.next()}async*search(t){this.clearSearch();const{searchMatcher:e}=await f.e(849).then(f.bind(f,92849)),{query:s,index:r}=t,a=e(yt,{defaultLocale:this.language,...t}),o=r!=null?w(this,y,Pt).call(this,a,s,r):w(this,y,zt).call(this,a,s),l=[];d(this,P).set(r,l);for await(const c of o)if(c.subitems){const h=c.subitems.map(({cfi:u})=>({value:D+u}));d(this,P).set(c.index,h);for(const u of h)this.addAnnotation(u);yield{label:d(this,F).getProgress(c.index)?.label??"",subitems:c.subitems}}else{if(c.cfi){const h={value:D+c.cfi};l.push(h),this.addAnnotation(h)}yield c}yield"done"}clearSearch(){for(const t of d(this,P).values())for(const e of t)this.deleteAnnotation(e);d(this,P).clear()}async initTTS(t="word",e){const s=this.renderer.getContents()[0].doc;if(this.tts&&this.tts.doc===s)return;const{TTS:r}=await f.e(866).then(f.bind(f,79866));this.tts=new r(s,yt,e||(a=>this.renderer.scrollToAnchor(a,!0)),t)}startMediaOverlay(){const{index:t}=this.renderer.getContents()[0];return this.mediaOverlay.start(t)}}G=new WeakMap,N=new WeakMap,F=new WeakMap,$=new WeakMap,P=new WeakMap,X=new WeakMap,y=new WeakSet,z=function(t,e,s){return this.dispatchEvent(new CustomEvent(t,{detail:e,cancelable:s}))},St=function({reason:t,range:e,index:s,fraction:r,size:a}){const o=d(this,N)?.getProgress(s,r,a)??{},l=d(this,F)?.getProgress(s,e),c=d(this,$)?.getProgress(s,e),h=this.getCFI(s,e);this.lastLocation={...o,tocItem:l,pageItem:c,cfi:h,range:e},(t==="snap"||t==="page"||t==="scroll")&&this.history.replaceState(h),w(this,y,z).call(this,"relocate",this.lastLocation)},It=function({doc:t,index:e}){var s,r;(s=t.documentElement).lang||(s.lang=this.language.canonical??""),this.language.isCJK||(r=t.documentElement).dir||(r.dir=this.language.direction??""),w(this,y,Lt).call(this,t,e),d(this,X).cloneFor(t.documentElement),w(this,y,z).call(this,"load",{doc:t,index:e})},Lt=function(t,e){const{book:s}=this,r=s.sections[e];t.addEventListener("click",a=>{const o=a.target.closest("a[href]");if(!o)return;a.preventDefault();const l=o.getAttribute("href"),c=r?.resolveHref?.(l)??l;s?.isExternal?.(c)?Promise.resolve(w(this,y,z).call(this,"external-link",{a:o,href:c},!0)).then(h=>h?globalThis.open(c,"_blank"):null).catch(h=>console.error(h)):Promise.resolve(w(this,y,z).call(this,"link",{a:o,href:c},!0)).then(h=>h?this.goTo(c):null).catch(h=>console.error(h))})},Z=function(t){return this.renderer.getContents().find(e=>e.index===t&&e.overlayer)},Nt=function({doc:t,index:e}){const s=new pt;t.addEventListener("click",a=>{const[o,l]=s.hitTest(a);o&&!o.startsWith(D)&&w(this,y,z).call(this,"show-annotation",{value:o,index:e,range:l})},!1);const r=d(this,P).get(e);if(r)for(const a of r)this.addAnnotation(a);return w(this,y,z).call(this,"create-overlay",{index:e}),s},Pt=async function*(t,e,s){const r=await this.book.sections[s].createDocument();for(const{range:a,excerpt:o}of t(r,e))yield{cfi:this.getCFI(s,a),excerpt:o}},zt=async function*(t,e){const{sections:s}=this.book;for(const[r,{createDocument:a}]of s.entries()){if(!a)continue;const o=await a(),l=Array.from(t(o,e),({range:c,excerpt:h})=>({cfi:this.getCFI(r,c),excerpt:h}));yield{progress:(r+1)/s.length},l.length&&(yield{index:r,subitems:l})}},customElements.define("foliate-view",Et);const re=Object.freeze(Object.defineProperty({__proto__:null,NotFoundError:bt,ResponseError:vt,UnsupportedTypeError:xt,View:Et,makeBook:At},Symbol.toStringTag,{value:"Module"}))}}]);
}());