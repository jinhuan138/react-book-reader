!(function(){"use strict";var te=Object.defineProperty;var $t=v=>{throw TypeError(v)};var ee=(v,S,A)=>S in v?te(v,S,{enumerable:!0,configurable:!0,writable:!0,value:A}):v[S]=A;var yt=(v,S,A)=>ee(v,typeof S!="symbol"?S+"":S,A),bt=(v,S,A)=>S.has(v)||$t("Cannot "+A);var n=(v,S,A)=>(bt(v,S,"read from private field"),A?A.call(v):S.get(v)),L=(v,S,A)=>S.has(v)?$t("Cannot add the same private member more than once"):S instanceof WeakSet?S.add(v):S.set(v,A),T=(v,S,A,U)=>(bt(v,S,"write to private field"),U?U.call(v,A):S.set(v,A),A),w=(v,S,A)=>(bt(v,S,"access private method"),A);var Ct=(v,S,A,U)=>({set _(I){T(v,S,I,A)},get _(){return n(v,S,U)}});(self.webpackChunkreact_book_reader_docs=self.webpackChunkreact_book_reader_docs||[]).push([[535],{22535:function(v,S,A){var q,it,K,k,R,N,nt,at,z,m,Nt,pt,W,J,ut,dt,Q,wt,ot,Z,lt,_,D,P,G,tt,O,F;A.d(S,{EPUB:function(){return Zt}});var U=A(44169);const I={CONTAINER:"urn:oasis:names:tc:opendocument:xmlns:container",XHTML:"http://www.w3.org/1999/xhtml",OPF:"http://www.idpf.org/2007/opf",EPUB:"http://www.idpf.org/2007/ops",DC:"http://purl.org/dc/elements/1.1/",ENC:"http://www.w3.org/2001/04/xmlenc#",NCX:"http://www.daisy.org/z3986/2005/ncx/",XLINK:"http://www.w3.org/1999/xlink",SMIL:"http://www.w3.org/ns/SMIL"},M={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},X={a11y:"http://www.idpf.org/epub/vocab/package/a11y/#",dcterms:"http://purl.org/dc/terms/",marc:"http://id.loc.gov/vocabulary/",media:"http://www.idpf.org/epub/vocab/overlays/#",onix:"http://www.editeur.org/ONIX/book/codelists/current.html#",rendition:"http://www.idpf.org/vocab/rendition/#",schema:"http://schema.org/",xsd:"http://www.w3.org/2001/XMLSchema#",msv:"http://www.idpf.org/epub/vocab/structure/magazine/#",prism:"http://www.prismstandard.org/specifications/3.0/PRISM_CV_Spec_3.0.htm#"},Bt={art:"artist",aut:"author",clr:"colorist",edt:"editor",ill:"illustrator",nrt:"narrator",trl:"translator",pbl:"publisher"},Mt={"02":"isbn","06":"doi",15:"isbn",26:"doi",34:"issn"},ft=i=>i.toLowerCase().replace(/[-:](.)/g,(t,e)=>e.toUpperCase()),Rt=i=>i?i.replace(/[\t\n\f\r ]+/g," ").replace(/^[\t\n\f\r ]+/,"").replace(/[\t\n\f\r ]+$/,""):"",kt=(i,t,e)=>e?r=>r.getAttribute(i)?.split(/\s/)?.includes(t):typeof t=="function"?r=>t(r.getAttribute(i)):r=>r.getAttribute(i)===t,ht=(...i)=>t=>t?Object.fromEntries(i.map(e=>[ft(e),t.getAttribute(e)])):null,H=i=>Rt(i?.textContent),rt=(i,t)=>{const e=i.lookupNamespaceURI(null)===t||i.lookupPrefix(t),r=e?(s,l)=>o=>o.namespaceURI===t&&o.localName===l:(s,l)=>o=>o.localName===l;return{$:(s,l)=>[...s.children].find(r(s,l)),$$:(s,l)=>[...s.children].filter(r(s,l)),$$$:e?(s,l)=>[...s.getElementsByTagNameNS(t,l)]:(s,l)=>[...s.getElementsByTagName(l)]}},Y=(i,t)=>{try{if(t.includes(":"))return new URL(i,t);const e="https://invalid.invalid/",r=new URL(i,e+t);return r.search="",decodeURI(r.href.replace(e,""))}catch(e){return console.warn(e),i}},vt=i=>/^(?!blob)\w+:/i.test(i),Ot=(i,t)=>{if(!i)return t;const e=i.replace(/\/$/,"").split("/"),r=t.replace(/\/$/,"").split("/"),s=(e.length>r.length?e:r).findIndex((l,o)=>e[o]!==r[o]);return s<0?"":Array(e.length-s).fill("..").concat(r.slice(s)).join("/")},Ut=i=>i.slice(0,i.lastIndexOf("/")+1),st=async(i,t,e)=>{const r=[];i.replace(t,(...l)=>(r.push(l),null));const s=[];for(const l of r)s.push(await e(...l));return i.replace(t,()=>s.shift())},Pt=i=>i.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),mt=i=>{for(const[e,r]of Object.entries(i))r==null?delete i[e]:Array.isArray(r)?(i[e]=r.filter(s=>s).map(s=>typeof s=="object"&&!Array.isArray(s)?mt(s):s),i[e].length?i[e].length===1&&(i[e]=i[e][0]):delete i[e]):typeof r=="object"&&(i[e]=mt(r),Object.keys(r).length||delete i[e]);const t=Object.keys(i);return t.length===1&&t[0]==="name"?i[t[0]]:i},jt=i=>{const t=new Map(Object.entries(X)),e=i.documentElement.getAttributeNS(I.EPUB,"prefix")||i.documentElement.getAttribute("prefix");if(e)for(const[,r,s]of e.matchAll(/(.+): +(.+)[ \t\r\n]*/g))t.set(r,s);return t},St=(i,t)=>{if(!i)return null;const[e,r]=i.split(":"),s=r?e:null,l=r||e,o=t.get(s);return o?o+l:null},Ht=i=>{const{$:t}=rt(i,I.OPF),e=t(i.documentElement,"metadata"),r=Object.groupBy(e.children,a=>a.namespaceURI===I.DC?"dc":a.namespaceURI===I.OPF&&a.localName==="meta"?a.hasAttribute("name")?"legacyMeta":"meta":""),s=e.getAttribute("xml:lang")??i.documentElement.getAttribute("xml:lang")??"und",l=jt(i),o=a=>{const g=a.getAttribute("property"),$=a.getAttribute("scheme");return{property:St(g,l)??g,scheme:St($,l)??$,lang:a.getAttribute("xml:lang"),value:H(a),props:c(a),attrs:Object.fromEntries(Array.from(a.attributes).filter(x=>x.namespaceURI===I.OPF).map(x=>[x.localName,x.value]))}},h=Map.groupBy(r.meta??[],a=>a.getAttribute("refines")),c=a=>{const g=h.get(a?"#"+a.getAttribute("id"):null);return g?Object.groupBy(g.map(o),$=>$.property):null},p=Object.fromEntries(Object.entries(Object.groupBy(r.dc,a=>a.localName)).map(([a,g])=>[a,g.map(o)])),d=c()??{},u=Object.fromEntries(r.legacyMeta?.map(a=>[a.getAttribute("name"),a.getAttribute("content")])??[]),y=a=>a?.[0]?.value,E=(a,g)=>y(a?.props?.[g]),f=a=>{var xt;if(!a)return null;const g=a.props?.["alternate-script"]??[],$=a.attrs["alt-rep"];if(!g.length&&(!a.lang||a.lang===s)&&!$)return a.value;const x={[a.lang??s]:a.value};$&&(x[a.attrs["alt-rep-lang"]]=$);for(const Lt of g)x[xt=Lt.lang]??(x[xt]=Lt.value);return x},b=a=>a?{name:f(a),sortAs:f(a.props?.["file-as"]?.[0])??a.attrs["file-as"],role:a.props?.role?.filter(g=>g.scheme===X.marc+"relators")?.map(g=>g.value)??[a.attrs.role],code:E(a,"term")??a.attrs.term,scheme:E(a,"authority")??a.attrs.authority}:null,C=a=>({name:f(a),position:y(a.props?.["group-position"])}),V=a=>{const{value:g}=a;if(/^urn:/i.test(g))return g;if(/^doi:/i.test(g))return`urn:${g}`;const $=a.props?.["identifier-type"];if(!$){const x=a.attrs.scheme;return x?/^(doi|isbn|uuid)$/i.test(x)?`urn:${x}:${g}`:{scheme:x,value:g}:g}if($.scheme===X.onix+"codelist5"){const x=Mt[$.value];if(x)return`urn:${x}:${g}`}return g},et=Object.groupBy(d["belongs-to-collection"]??[],a=>E(a,"collection-type")==="series"?"series":"collection"),B=p.title?.find(a=>E(a,"title-type")==="main")??p.title?.[0],j={identifier:At(i),title:f(B),sortAs:f(B?.props?.["file-as"]?.[0])??B?.attrs?.["file-as"]??u?.["calibre:title_sort"],subtitle:p.title?.find(a=>E(a,"title-type")==="subtitle")?.value,language:p.language?.map(a=>a.value),description:y(p.description),publisher:b(p.publisher?.[0]),published:p.date?.find(a=>a.attrs.event==="publication")?.value??y(p.date),modified:y(d[X.dcterms+"modified"])??p.date?.find(a=>a.attrs.event==="modification")?.value,subject:p.subject?.map(b),belongsTo:{collection:et.collection?.map(C),series:et.series?.map(C)??u?.["calibre:series"]?{name:u?.["calibre:series"],position:parseFloat(u?.["calibre:series_index"])}:null},altIdentifier:p.identifier?.map(V),source:p.source?.map(V),rights:y(p.rights)},It=a=>g=>{const $=new Set(g.role?.map(x=>Bt[x]??a));return[$.size?$:[a],g]};for(const[a,g]of[].concat(p.creator?.map(b)?.map(It("author"))??[],p.contributor?.map(b)?.map(It("contributor"))??[]))for(const $ of a)j[$]?j[$].push(g):j[$]=[g];mt(j),j.altIdentifier===j.identifier&&delete j.altIdentifier;const Tt={},ct={};for(const[a,g]of Object.entries(d))a.startsWith(X.rendition)?Tt[ft(a.replace(X.rendition,""))]=y(g):a.startsWith(X.media)&&(ct[ft(a.replace(X.media,""))]=y(g));return ct.duration&&(ct.duration=gt(ct.duration)),{metadata:j,rendition:Tt,media:ct}},_t=(i,t=e=>e)=>{const{$:e,$$:r,$$$:s}=rt(i,I.XHTML),l=f=>f?decodeURI(t(f)):null,o=f=>b=>{const C=e(b,"a")??e(b,"span"),V=e(b,"ol"),et=l(C?.getAttribute("href")),B={label:H(C)||C?.getAttribute("title"),href:et,subitems:h(V)};return f&&(B.type=C?.getAttributeNS(I.EPUB,"type")?.split(/\s/)),B},h=(f,b)=>f?r(f,"li").map(o(b)):null,c=(f,b)=>h(e(f,"ol"),b),p=s(i,"nav");let d=null,u=null,y=null,E=[];for(const f of p){const b=f.getAttributeNS(I.EPUB,"type")?.split(/\s/)??[];b.includes("toc")?d??(d=c(f)):b.includes("page-list")?u??(u=c(f)):b.includes("landmarks")?y??(y=c(f,!0)):E.push({label:H(f.firstElementChild),type:b,list:c(f)})}return{toc:d,pageList:u,landmarks:y,others:E}},Dt=(i,t=e=>e)=>{const{$:e,$$:r}=rt(i,I.NCX),s=c=>c?decodeURI(t(c)):null,l=c=>{const p=e(c,"navLabel"),d=e(c,"content"),u=H(p),y=s(d.getAttribute("src"));if(c.localName==="navPoint"){const E=r(c,"navPoint");return{label:u,href:y,subitems:E.length?E.map(l):null}}return{label:u,href:y}},o=(c,p)=>r(c,p).map(l),h=(c,p)=>{const d=e(i.documentElement,c);return d?o(d,p):null};return{toc:h("navMap","navPoint"),pageList:h("pageList","pageTarget"),others:r(i.documentElement,"navList").map(c=>({label:H(e(c,"navLabel")),list:o(c,"navTarget")}))}},gt=i=>{if(!i)return;const t=i.split(":").map(s=>parseFloat(s));if(t.length===3){const[s,l,o]=t;return s*60*60+l*60+o}if(t.length===2){const[s,l]=t;return s*60+l}const[e,r]=i.split(/(?=[^\d.])/);return parseFloat(e)*(r==="h"?3600:r==="min"?60:r==="ms"?.001:1)};class Ft extends EventTarget{constructor(e,r){super();L(this,m);L(this,q);L(this,it);L(this,K);L(this,k);L(this,R);L(this,N);L(this,nt,1);L(this,at,1);L(this,z);this.book=e,this.loadXML=r}async start(e,r=()=>!0){n(this,N)?.pause();const s=this.book.sections[e],l=s?.id;if(!l)return;const{mediaOverlay:o}=s;if(!o)return this.start(e+1);T(this,K,e),await w(this,m,Nt).call(this,o);for(let h=0;h<n(this,q).length;h++){const{items:c}=n(this,q)[h];for(let p=0;p<c.length;p++)if(c[p].text.split("#")[0]===l&&r(c[p],p,c))return w(this,m,Q).call(this,h,p).catch(d=>w(this,m,J).call(this,d))}}pause(){T(this,z,"paused"),n(this,N)?.pause()}resume(){T(this,z,"playing"),n(this,N)?.play().catch(e=>w(this,m,J).call(this,e))}stop(){T(this,z,"stopped"),w(this,m,wt).call(this)}prev(){n(this,R)>0?w(this,m,Q).call(this,n(this,k),n(this,R)-1):n(this,k)>0?w(this,m,Q).call(this,n(this,k)-1,n(this,q)[n(this,k)-1].items.length-1):n(this,K)>0&&this.start(n(this,K)-1,(e,r,s)=>r===s.length-1)}next(){w(this,m,Q).call(this,n(this,k),n(this,R)+1)}setVolume(e){T(this,nt,e),n(this,N)&&(n(this,N).volume=e)}setRate(e){T(this,at,e),n(this,N)&&(n(this,N).playbackRate=e)}}q=new WeakMap,it=new WeakMap,K=new WeakMap,k=new WeakMap,R=new WeakMap,N=new WeakMap,nt=new WeakMap,at=new WeakMap,z=new WeakMap,m=new WeakSet,Nt=async function(e){if(n(this,it)===e)return;const r=await this.loadXML(e.href),s=h=>h?Y(h,e.href):null,{$:l,$$$:o}=rt(r,I.SMIL);T(this,k,-1),T(this,R,-1),T(this,q,o(r,"par").reduce((h,c)=>{const p=s(l(c,"text")?.getAttribute("src")),d=l(c,"audio");if(!p||!d)return h;const u=s(d.getAttribute("src")),y=gt(d.getAttribute("clipBegin")),E=gt(d.getAttribute("clipEnd")),f=h.at(-1);return f?.src===u?f.items.push({text:p,begin:y,end:E}):h.push({src:u,items:[{text:p,begin:y,end:E}]}),h},[])),T(this,it,e)},pt=function(){return n(this,q)[n(this,k)]},W=function(){return n(this,m,pt)?.items?.[n(this,R)]},J=function(e){console.error(e),this.dispatchEvent(new CustomEvent("error",{detail:e}))},ut=function(){this.dispatchEvent(new CustomEvent("highlight",{detail:n(this,m,W)}))},dt=function(){this.dispatchEvent(new CustomEvent("unhighlight",{detail:n(this,m,W)}))},Q=async function(e,r){w(this,m,wt).call(this),T(this,k,e),T(this,R,r);const s=n(this,m,pt)?.src;if(!s||!n(this,m,W))return this.start(n(this,K)+1);const l=URL.createObjectURL(await this.book.loadBlob(s)),o=new Audio(l);T(this,N,o),o.volume=n(this,nt),o.playbackRate=n(this,at),o.addEventListener("timeupdate",()=>{if(o.paused)return;const h=o.currentTime,{items:c}=n(this,m,pt);if(h>n(this,m,W)?.end&&(w(this,m,dt).call(this),n(this,R)===c.length-1)){w(this,m,Q).call(this,n(this,k)+1,0).catch(d=>w(this,m,J).call(this,d));return}const p=n(this,R);for(;c[n(this,R)+1]?.begin<=h;)Ct(this,R)._++;n(this,R)!==p&&w(this,m,ut).call(this)}),o.addEventListener("error",()=>w(this,m,J).call(this,new Error(`Failed to load ${s}`))),o.addEventListener("playing",()=>w(this,m,ut).call(this)),o.addEventListener("ended",()=>{w(this,m,dt).call(this),URL.revokeObjectURL(l),T(this,N,null),w(this,m,Q).call(this,e+1,0).catch(h=>w(this,m,J).call(this,h))}),n(this,z)==="paused"?(w(this,m,ut).call(this),o.currentTime=n(this,m,W).begin??0):o.addEventListener("canplaythrough",()=>{o.currentTime=n(this,m,W).begin??0,T(this,z,"playing"),o.play().catch(h=>w(this,m,J).call(this,h))},{once:!0})},wt=function(){n(this,N)&&(n(this,N).pause(),URL.revokeObjectURL(n(this,N).src),T(this,N,null),w(this,m,dt).call(this))};const Xt=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,qt=i=>{for(const t of i.getElementsByTagNameNS(I.DC,"identifier")){const[e]=H(t).split(":").slice(-1);if(Xt.test(e))return e}return""},At=i=>H(i.getElementById(i.documentElement.getAttribute("unique-identifier"))??i.getElementsByTagNameNS(I.DC,"identifier")[0]),Et=async(i,t,e)=>{const r=new Uint8Array(await e.slice(0,t).arrayBuffer());t=Math.min(t,r.length);for(var s=0;s<t;s++)r[s]=r[s]^i[s%i.length];return new Blob([r,e.slice(t)],{type:e.type})},zt=async i=>{const t=new TextEncoder().encode(i),e=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(e)},Gt=(i=zt)=>({"http://www.idpf.org/2008/embedding":{key:t=>i(At(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(t,e)=>Et(t,1040,e)},"http://ns.adobe.com/pdf/enc#RC":{key:t=>{const e=qt(t).replaceAll("-","");return Uint8Array.from({length:16},(r,s)=>parseInt(e.slice(s*2,s*2+2),16))},decode:(t,e)=>Et(t,1024,e)}});class Vt{constructor(t){L(this,ot,new Map);L(this,Z,new Map);L(this,lt);T(this,lt,t)}async init(t,e){if(!t)return;const r=Array.from(t.getElementsByTagNameNS(I.ENC,"EncryptedData"),s=>({algorithm:s.getElementsByTagNameNS(I.ENC,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:s.getElementsByTagNameNS(I.ENC,"CipherReference")[0]?.getAttribute("URI")}));for(const{algorithm:s,uri:l}of r){if(!n(this,Z).has(s)){const o=n(this,lt)[s];if(!o){console.warn("Unknown encryption algorithm");continue}const h=await o.key(e);n(this,Z).set(s,c=>o.decode(h,c))}n(this,ot).set(l,s)}}getDecoder(t){return n(this,Z).get(n(this,ot).get(t))??(e=>e)}}ot=new WeakMap,Z=new WeakMap,lt=new WeakMap;class Kt{constructor({opf:t,resolveHref:e}){this.opf=t;const{$:r,$$:s,$$$:l}=rt(t,I.OPF),o=r(t.documentElement,"manifest"),h=r(t.documentElement,"spine"),c=s(h,"itemref");this.manifest=s(o,"item").map(ht("href","id","media-type","properties","media-overlay")).map(d=>(d.href=e(d.href),d.properties=d.properties?.split(/\s/),d)),this.manifestById=new Map(this.manifest.map(d=>[d.id,d])),this.spine=c.map(ht("idref","id","linear","properties")).map(d=>(d.properties=d.properties?.split(/\s/),d)),this.pageProgressionDirection=h.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(h.getAttribute("toc"))??this.manifest.find(d=>d.mediaType===M.NCX))?.href;const p=r(t.documentElement,"guide");p&&(this.guide=s(p,"reference").map(ht("type","title","href")).map(({type:d,title:u,href:y})=>({label:u,type:d.split(/\s/),href:e(y)}))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(l(t,"meta").find(kt("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find(d=>d.type.includes("cover"))?.href),this.cfis=(0,U.f)(c)}getItemByID(t){return this.manifestById.get(t)}getItemByHref(t){return this.manifest.find(e=>e.href===t)}getItemByProperty(t){return this.manifest.find(e=>e.properties?.includes(t))}resolveCFI(t){const e=(0,U.p)(t),r=(e.parent??e).shift();let s=(0,U.t)(this.opf,r);s&&s.nodeName!=="idref"&&(r.at(-1).id=null,s=(0,U.t)(this.opf,r));const l=s?.getAttribute("idref");return{index:this.spine.findIndex(o=>o.idref===l),anchor:o=>(0,U.a)(o,e)}}}class Wt{constructor({loadText:t,loadBlob:e,resources:r}){L(this,_,new Map);L(this,D,new Map);L(this,P,new Map);yt(this,"eventTarget",new EventTarget);this.loadText=t,this.loadBlob=e,this.manifest=r.manifest,this.assets=r.manifest}async createURL(t,e,r,s){if(!e)return"";const l={data:e,type:r};Object.defineProperty(l,"name",{value:t});const o=new CustomEvent("data",{detail:l});this.eventTarget.dispatchEvent(o);const h=await o.detail.data,c=await o.detail.type,p=URL.createObjectURL(new Blob([h],{type:c}));if(n(this,_).set(t,p),n(this,P).set(t,1),s){const d=n(this,D).get(s);d?d.push(t):n(this,D).set(s,[t])}return p}ref(t,e){const r=n(this,D).get(e);return r?.includes(t)||(n(this,P).set(t,n(this,P).get(t)+1),r?r.push(t):n(this,D).set(e,[t])),n(this,_).get(t)}unref(t){if(!n(this,P).has(t))return;const e=n(this,P).get(t)-1;if(e<1){URL.revokeObjectURL(n(this,_).get(t)),n(this,_).delete(t),n(this,P).delete(t);const r=n(this,D).get(t);if(r)for(;r.length;)this.unref(r.pop());n(this,D).delete(t)}else n(this,P).set(t,e)}async loadItem(t,e=[]){if(!t)return null;const{href:r,mediaType:s}=t,l=M.JS.test(t.mediaType),o={type:s,isScript:l,allow:!0},h=new CustomEvent("load",{detail:o});if(this.eventTarget.dispatchEvent(h),!await h.detail.allow)return null;const c=e.at(-1);if(n(this,_).has(r))return this.ref(r,c);if((l||[M.XHTML,M.HTML,M.CSS,M.SVG].includes(s))&&e.every(d=>d!==r))return this.loadReplaced(t,e);const p=Promise.resolve().then(()=>this.loadBlob(r));return this.createURL(r,p,s,c)}async loadHref(t,e,r=[]){if(vt(t))return t;const s=Y(t,e),l=this.manifest.find(o=>o.href===s);return l?this.loadItem(l,r.concat(e)):t}async loadReplaced(t,e=[]){const{href:r,mediaType:s}=t,l=e.at(-1);let o="";try{o=await this.loadText(r)}catch(c){return this.createURL(r,Promise.reject(c),s,l)}if(!o)return null;if([M.XHTML,M.HTML,M.SVG].includes(s)){let c=new DOMParser().parseFromString(o,s);if(s===M.XHTML&&(c.querySelector("parsererror")||!c.documentElement?.namespaceURI)&&(console.warn(c.querySelector("parsererror")?.innerText??"Invalid XHTML"),t.mediaType=M.HTML,c=new DOMParser().parseFromString(o,t.mediaType)),[M.XHTML,M.SVG].includes(t.mediaType)){let u=c.firstChild;for(;u instanceof ProcessingInstruction;){if(u.data){const y=await st(u.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,(E,f,b,C)=>this.loadHref(b,r,e).then(V=>`${f}${V}${C}`));u.replaceWith(c.createProcessingInstruction(u.target,y))}u=u.nextSibling}}const p=async(u,y)=>u.setAttribute(y,await this.loadHref(u.getAttribute(y),r,e));for(const u of c.querySelectorAll("link[href]"))await p(u,"href");for(const u of c.querySelectorAll("[src]"))await p(u,"src");for(const u of c.querySelectorAll("[poster]"))await p(u,"poster");for(const u of c.querySelectorAll("object[data]"))await p(u,"data");for(const u of c.querySelectorAll("[*|href]:not([href])"))u.setAttributeNS(I.XLINK,"href",await this.loadHref(u.getAttributeNS(I.XLINK,"href"),r,e));for(const u of c.querySelectorAll("[srcset]"))u.setAttribute("srcset",await st(u.getAttribute("srcset"),/(\s*)(.+?)\s*((?:\s[\d.]+[wx])+\s*(?:,|$)|,\s+|$)/g,(y,E,f,b)=>this.loadHref(f,r,e).then(C=>`${E}${C}${b}`)));for(const u of c.querySelectorAll("style"))u.textContent&&(u.textContent=await this.replaceCSS(u.textContent,r,e));for(const u of c.querySelectorAll("[style]"))u.setAttribute("style",await this.replaceCSS(u.getAttribute("style"),r,e));const d=new XMLSerializer().serializeToString(c);return this.createURL(r,d,t.mediaType,l)}const h=s===M.CSS?await this.replaceCSS(o,r,e):await this.replaceString(o,r,e);return this.createURL(r,h,s,l)}async replaceCSS(t,e,r=[]){const s=await st(t,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,(l,o)=>this.loadHref(o,e,r).then(h=>`url("${h}")`));return st(s,/@import\s*["']([^"'\n]*?)["']/gi,(l,o)=>this.loadHref(o,e,r).then(h=>`@import "${h}"`))}replaceString(t,e,r=[]){const s=new Map,l=this.assets.map(h=>{if(h.href===e)return;const c=Ot(Ut(e),h.href),p=encodeURI(c),d="/"+h.href,u=encodeURI(d),y=new Set([c,p,d,u]);for(const E of y)s.set(E,h);return Array.from(y)}).flat().filter(h=>h);if(!l.length)return t;const o=new RegExp(l.map(Pt).join("|"),"g");return st(t,o,async h=>this.loadItem(s.get(h.replace(/^\//,"")),r.concat(e)))}unloadItem(t){this.unref(t?.href)}destroy(){for(const t of n(this,_).values())URL.revokeObjectURL(t)}}_=new WeakMap,D=new WeakMap,P=new WeakMap;const Jt=(i,t)=>i.getElementById(t)??i.querySelector(`[name="${CSS.escape(t)}"]`),Qt=i=>{for(const t of i){if(t==="page-spread-left"||t==="rendition:page-spread-left")return"left";if(t==="page-spread-right"||t==="rendition:page-spread-right")return"right";if(t==="rendition:page-spread-center")return"center"}},Yt=i=>i?{fixedLayout:H(i.querySelector('option[name="fixed-layout"]')),openToSpread:H(i.querySelector('option[name="open-to-spread"]'))}:null;class Zt{constructor({loadText:t,loadBlob:e,getSize:r,sha1:s}){L(this,O);yt(this,"parser",new DOMParser);L(this,G);L(this,tt);this.loadText=t,this.loadBlob=e,this.getSize=r,T(this,tt,new Vt(Gt(s)))}async init(){var y,E;const t=await w(this,O,F).call(this,"META-INF/container.xml");if(!t)throw new Error("Failed to load container file");const e=Array.from(t.getElementsByTagNameNS(I.CONTAINER,"rootfile"),ht("full-path","media-type")).filter(f=>f.mediaType==="application/oebps-package+xml");if(!e.length)throw new Error("No package document defined in container");const r=e[0].fullPath,s=await w(this,O,F).call(this,r);if(!s)throw new Error("Failed to load package document");const l=await w(this,O,F).call(this,"META-INF/encryption.xml");await n(this,tt).init(l,s),this.resources=new Kt({opf:s,resolveHref:f=>Y(f,r)}),T(this,G,new Wt({loadText:this.loadText,loadBlob:f=>Promise.resolve(this.loadBlob(f)).then(n(this,tt).getDecoder(f)),resources:this.resources})),this.transformTarget=n(this,G).eventTarget,this.sections=this.resources.spine.map((f,b)=>{const{idref:C,linear:V,properties:et=[]}=f,B=this.resources.getItemByID(C);return B?{id:B.href,load:()=>n(this,G).loadItem(B),unload:()=>n(this,G).unloadItem(B),createDocument:()=>this.loadDocument(B),size:this.getSize(B.href),cfi:this.resources.cfis[b],linear:V,pageSpread:Qt(et),resolveHref:j=>Y(j,B.href),mediaOverlay:B.mediaOverlay?this.resources.getItemByID(B.mediaOverlay):null}:(console.warn(`Could not find item with ID "${C}" in manifest`),null)}).filter(f=>f);const{navPath:o,ncxPath:h}=this.resources;if(o)try{const f=C=>Y(C,o),b=_t(await w(this,O,F).call(this,o),f);this.toc=b.toc,this.pageList=b.pageList,this.landmarks=b.landmarks}catch(f){console.warn(f)}if(!this.toc&&h)try{const f=C=>Y(C,h),b=Dt(await w(this,O,F).call(this,h),f);this.toc=b.toc,this.pageList=b.pageList}catch(f){console.warn(f)}this.landmarks??(this.landmarks=this.resources.guide);const{metadata:c,rendition:p,media:d}=Ht(s);this.metadata=c,this.rendition=p,this.media=d,this.dir=this.resources.pageProgressionDirection;const u=Yt(await w(this,O,F).call(this,"META-INF/com.apple.ibooks.display-options.xml")??await w(this,O,F).call(this,"META-INF/com.kobobooks.display-options.xml"));return u&&(u.fixedLayout==="true"&&((y=this.rendition).layout??(y.layout="pre-paginated")),u.openToSpread==="false"&&((E=this.sections.find(f=>f.linear!=="no")).pageSpread??(E.pageSpread=this.dir==="rtl"?"left":"right"))),this}async loadDocument(t){const e=await this.loadText(t.href);return this.parser.parseFromString(e,t.mediaType)}getMediaOverlay(){return new Ft(this,w(this,O,F).bind(this))}resolveCFI(t){return this.resources.resolveCFI(t)}resolveHref(t){const[e,r]=t.split("#"),s=this.resources.getItemByHref(decodeURI(e));return s?{index:this.resources.spine.findIndex(({idref:l})=>l===s.id),anchor:r?l=>Jt(l,r):()=>0}:null}splitTOCHref(t){return t?.split("#")??[]}getTOCFragment(t,e){return t.getElementById(e)??t.querySelector(`[name="${CSS.escape(e)}"]`)}isExternal(t){return vt(t)}async getCover(){const t=this.resources?.cover;return t?.href?new Blob([await this.loadBlob(t.href)],{type:t.mediaType}):null}async getCalibreBookmarks(){const t=await this.loadText("META-INF/calibre_bookmarks.txt"),e="encoding=json+base64:";if(t?.startsWith(e)){const r=atob(t.slice(e.length));return JSON.parse(r)}}destroy(){n(this,G)?.destroy()}}G=new WeakMap,tt=new WeakMap,O=new WeakSet,F=async function(t){const e=await this.loadText(t);if(!e)return null;const r=this.parser.parseFromString(e,M.XML);if(r.querySelector("parsererror"))throw new Error(`XML parsing error: ${t}
${r.querySelector("parsererror").innerText}`);return r}}}]);
}());