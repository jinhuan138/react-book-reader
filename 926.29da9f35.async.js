"use strict";(self.webpackChunkreact_book_reader_docs=self.webpackChunkreact_book_reader_docs||[]).push([[926],{52926:function(ye,Dt,zt){zt.d(Dt,{MOBI:function(){return he},isMOBI:function(){return le}});var Ht=Object.defineProperty,Nt=(s,t,e)=>t in s?Ht(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,q=(s,t,e)=>(Nt(s,typeof t!="symbol"?t+"":t,e),e),mt=(s,t,e)=>{if(!t.has(s))throw TypeError("Cannot "+e)},o=(s,t,e)=>(mt(s,t,"read from private field"),e?e.call(s):t.get(s)),w=(s,t,e)=>{if(t.has(s))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(s):t.set(s,e)},k=(s,t,e,i)=>(mt(s,t,"write to private field"),i?i.call(s,e):t.set(s,e),e),xt=(s,t,e,i)=>({set _(n){k(s,t,n,e)},get _(){return o(s,t,i)}}),P=(s,t,e)=>(mt(s,t,"access private method"),e);const I=s=>{if(!s)return"";const t=document.createElement("textarea");return t.innerHTML=s,t.value},A={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},_t={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},jt={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},Xt={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},Gt={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},$t={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},St={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},qt={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},Pt={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},Vt={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},Zt={magic:[0,4,"string"],numEntries:[8,4,"uint"]},Yt={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},Kt={1252:"windows-1252",65001:"utf-8"},At={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},Jt={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},it=(s,t)=>{const e=new s.constructor(s.length+t.length);return e.set(s),e.set(t,s.length),e},Et=(s,t,e)=>{const i=new s.constructor(s.length+t.length+e.length);return i.set(s),i.set(t,s.length),i.set(e,s.length+t.length),i},Qt=new TextDecoder,V=s=>Qt.decode(s),M=s=>{if(!s)return;const t=s.byteLength,e=t===4?"getUint32":t===2?"getUint16":"getUint8";return new DataView(s)[e](0)},x=(s,t)=>Object.fromEntries(Array.from(Object.entries(s)).map(([e,[i,n,a]])=>[e,(a==="string"?V:M)(t.slice(i,i+n))])),wt=s=>new TextDecoder(Kt[s]),st=(s,t=0)=>{let e=0,i=0;for(const n of s.subarray(t,t+4))if(e=e<<7|(n&127)>>>0,i++,n&128)break;return{value:e,length:i}},te=s=>{let t=0;for(const e of s.subarray(-4))e&128&&(t=0),t=t<<7|e&127;return t},Tt=s=>{let t=0;for(;s>0;s=s>>1)(s&1)===1&&t++;return t},ee=s=>{let t=0;for(;!(s&1);)s=s>>1,t++;return t},ne=s=>{let t=[];for(let e=0;e<s.length;e++){const i=s[e];if(i===0)t.push(0);else if(i<=8)for(const n of s.subarray(e+1,(e+=i)+1))t.push(n);else if(i<=127)t.push(i);else if(i<=191){const n=i<<8|s[e+++1],a=(n&16383)>>>3,r=(n&7)+3;for(let l=0;l<r;l++)t.push(t[t.length-a])}else t.push(32,i^128)}return Uint8Array.from(t)},ie=(s,t)=>{const e=t>>3,i=t+32,n=i>>3;let a=0n;for(let r=e;r<=n;r++)a=a<<8n|BigInt(s[r]??0);return a>>8n-BigInt(i&7)&0xffffffffn},se=async(s,t)=>{const e=await t(s.huffcdic),{magic:i,offset1:n,offset2:a}=x(Pt,e);if(i!=="HUFF")throw new Error("Invalid HUFF record");const r=Array.from({length:256},(d,b)=>n+b*4).map(d=>M(e.slice(d,d+4))).map(d=>[d&128,d&31,d>>>8]),l=[null].concat(Array.from({length:32},(d,b)=>a+b*8).map(d=>[M(e.slice(d,d+4)),M(e.slice(d+4,d+8))])),u=[];for(let d=1;d<s.numHuffcdic;d++){const b=await t(s.huffcdic+d),p=x(Vt,b);if(p.magic!=="CDIC")throw new Error("Invalid CDIC record");const c=Math.min(1<<p.codeLength,p.numEntries-u.length),h=b.slice(p.length);for(let f=0;f<c;f++){const g=M(h.slice(f*2,f*2+2)),y=M(h.slice(g,g+2)),v=y&32767,R=y&32768,T=new Uint8Array(h.slice(g+2,g+2+v));u.push([T,R])}}const m=d=>{let b=new Uint8Array;const p=d.byteLength*8;for(let c=0;c<p;){const h=Number(ie(d,c));let[f,g,y]=r[h>>>24];if(!f){for(;h>>>32-g<l[g][0];)g+=1;y=l[g][1]}if((c+=g)>p)break;const v=y-(h>>>32-g);let[R,T]=u[v];T||(R=m(R),u[v]=[R,!0]),b=it(b,R)}return b};return m},rt=async(s,t)=>{const e=await t(s),i=x(St,e);if(i.magic!=="INDX")throw new Error("Invalid INDX record");const n=wt(i.encoding),a=e.slice(i.length),r=x(qt,a);if(r.magic!=="TAGX")throw new Error("Invalid TAGX section");const l=(r.length-12)/4,u=Array.from({length:l},(p,c)=>new Uint8Array(a.slice(12+c*4,12+c*4+4))),m={};let d=0;for(let p=0;p<i.numCncx;p++){const c=await t(s+i.numRecords+p+1),h=new Uint8Array(c);for(let f=0;f<h.byteLength;){const g=f,{value:y,length:v}=st(h,f);f+=v;const R=c.slice(f,f+y);f+=y,m[d+g]=n.decode(R)}d+=65536}const b=[];for(let p=0;p<i.numRecords;p++){const c=await t(s+1+p),h=new Uint8Array(c),f=x(St,c);if(f.magic!=="INDX")throw new Error("Invalid INDX record");for(let g=0;g<f.numRecords;g++){const y=f.idxt+4+2*g,v=M(c.slice(y,y+2)),R=M(c.slice(v,v+1)),T=V(c.slice(v+1,v+1+R)),S=[],pt=v+1+R;let Ft=0,_=pt+r.numControlBytes;for(const[et,j,X,Mt]of u){if(Mt&1){Ft++;continue}const G=pt+Ft,C=M(c.slice(G,G+1))&X;if(C===X)if(Tt(X)>1){const{value:nt,length:$}=st(h,_);S.push([et,null,nt,j]),_+=$}else S.push([et,1,null,j]);else S.push([et,C>>ee(X),null,j])}const Wt={};for(const[et,j,X,Mt]of S){const G=[];if(j!=null)for(let C=0;C<j*Mt;C++){const{value:nt,length:$}=st(h,_);G.push(nt),_+=$}else{let C=0;for(;C<X;){const{value:nt,length:$}=st(h,_);G.push(nt),_+=$,C+=$}}Wt[et]=G}b.push({name:T,tagMap:Wt})}}return{table:b,cncx:m}},re=async(s,t)=>{const{table:e,cncx:i}=await rt(s,t),n=e.map(({tagMap:r},l)=>{var u,m,d,b,p,c;return{index:l,offset:(u=r[1])==null?void 0:u[0],size:(m=r[2])==null?void 0:m[0],label:i[r[3]]??"",headingLevel:(d=r[4])==null?void 0:d[0],pos:r[6],parent:(b=r[21])==null?void 0:b[0],firstChild:(p=r[22])==null?void 0:p[0],lastChild:(c=r[23])==null?void 0:c[0]}}),a=r=>(r.firstChild==null||(r.children=n.filter(l=>l.parent===r.index).map(a)),r);return n.filter(r=>r.headingLevel===0).map(a)},ae=(s,t)=>{const{magic:e,count:i}=x($t,s);if(e!=="EXTH")throw new Error("Invalid EXTH header");const n=wt(t),a={};let r=12;for(let l=0;l<i;l++){const u=M(s.slice(r,r+4)),m=M(s.slice(r+4,r+8));if(u in At){const[d,b,p]=At[u],c=s.slice(r+8,r+m),h=b==="uint"?M(c):n.decode(c);p?(a[d]??(a[d]=[]),a[d].push(h)):a[d]=h}r+=m}return a},oe=async(s,t)=>{const{flags:e,dataStart:i,keyLength:n,keyStart:a}=x(Yt,s),r=new Uint8Array(s.slice(i));if(e&2){const u=n===16?1024:1040,m=new Uint8Array(s.slice(a,a+n)),d=Math.min(u,r.length);for(var l=0;l<d;l++)r[l]=r[l]^m[l%m.length]}if(e&1)try{return await t(r)}catch(u){console.warn(u),console.warn("Failed to decompress font")}return r},le=async s=>V(await s.slice(60,68).arrayBuffer())==="BOOKMOBI";var Z,Y;class ce{constructor(){w(this,Z,void 0),w(this,Y,void 0),q(this,"pdb")}async open(t){k(this,Z,t);const e=x(_t,await t.slice(0,78).arrayBuffer());this.pdb=e;const i=await t.slice(78,78+e.numRecords*8).arrayBuffer();k(this,Y,Array.from({length:e.numRecords},(n,a)=>M(i.slice(a*8,a*8+4))).map((n,a,r)=>[n,r[a+1]]))}loadRecord(t){const e=o(this,Y)[t];if(!e)throw new RangeError("Record index out of bounds");return o(this,Z).slice(...e).arrayBuffer()}async loadMagic(t){const e=o(this,Y)[t][0];return V(await o(this,Z).slice(e,e+4).arrayBuffer())}}Z=new WeakMap,Y=new WeakMap;var K,at,ot,lt,J,ct,ht,bt,yt,Lt;class he extends ce{constructor({unzlib:t}){super(),w(this,ht),w(this,yt),w(this,K,0),w(this,at,void 0),w(this,ot,void 0),w(this,lt,void 0),w(this,J,void 0),w(this,ct,void 0),this.unzlib=t}async open(t){var e;await super.open(t),this.headers=P(this,ht,bt).call(this,await super.loadRecord(0)),k(this,at,this.headers.mobi.resourceStart);let i=this.headers.mobi.version>=8;if(!i){const n=(e=this.headers.exth)==null?void 0:e.boundary;if(n<4294967295)try{this.headers=P(this,ht,bt).call(this,await super.loadRecord(n)),k(this,K,n),i=!0}catch(a){console.warn(a),console.warn("Failed to open KF8; falling back to MOBI")}}return await P(this,yt,Lt).call(this),i?new be(this).init():new fe(this).init()}decode(...t){return o(this,ot).decode(...t)}encode(...t){return o(this,lt).encode(...t)}loadRecord(t){return super.loadRecord(o(this,K)+t)}loadMagic(t){return super.loadMagic(o(this,K)+t)}loadText(t){return this.loadRecord(t+1).then(e=>new Uint8Array(e)).then(o(this,ct)).then(o(this,J))}async loadResource(t){const e=await super.loadRecord(o(this,at)+t),i=V(e.slice(0,4));return i==="FONT"?oe(e,this.unzlib):i==="VIDE"||i==="AUDI"?e.slice(12):e}getNCX(){const t=this.headers.mobi.indx;if(t<4294967295)return re(t,this.loadRecord.bind(this))}getMetadata(){var t,e;const{mobi:i,exth:n}=this.headers;return{identifier:i.uid.toString(),title:I(n?.title||this.decode(i.title)),author:(t=n?.creator)==null?void 0:t.map(I),publisher:I(n?.publisher),language:n?.language??i.language,published:n?.date,description:I(n?.description),subject:(e=n?.subject)==null?void 0:e.map(I),rights:I(n?.rights)}}async getCover(){const{exth:t}=this.headers,e=t?.coverOffset<4294967295?t?.coverOffset:t?.thumbnailOffset<4294967295?t?.thumbnailOffset:null;if(e!=null){const i=await this.loadResource(e);return new Blob([i])}}}K=new WeakMap,at=new WeakMap,ot=new WeakMap,lt=new WeakMap,J=new WeakMap,ct=new WeakMap,ht=new WeakSet,bt=function(s){const t=x(jt,s),e=x(Xt,s);if(e.magic!=="MOBI")throw new Error("Missing MOBI header");const{titleOffset:i,titleLength:n,localeLanguage:a,localeRegion:r}=e;e.title=s.slice(i,i+n);const l=Jt[a];e.language=l?.[r>>2]??l?.[0];const u=e.exthFlag&64?ae(s.slice(e.length+16),e.encoding):null,m=e.version>=8?x(Gt,s):null;return{palmdoc:t,mobi:e,exth:u,kf8:m}},yt=new WeakSet,Lt=async function(){const{palmdoc:s,mobi:t}=this.headers;k(this,ot,wt(t.encoding)),k(this,lt,new TextEncoder);const{compression:e}=s;if(k(this,J,e===1?r=>r:e===2?ne:e===17480?await se(t,this.loadRecord.bind(this)):null),!o(this,J))throw new Error("Unknown compression type");const{trailingFlags:i}=t,n=i&1,a=Tt(i>>>1);k(this,ct,r=>{for(let l=0;l<a;l++){const u=te(r);r=r.subarray(0,-u)}if(n){const l=(r[r.length-1]&3)+1;r=r.subarray(0,-l)}return r})};const Ct=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,ue=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi,de=s=>{let t=0;for(;s;){const e=s.parentElement;if(e){const i=e.tagName.toLowerCase();i==="p"?t+=1.5:i==="blockquote"&&(t+=2)}s=e}return t};var W,Q,D,U,ut,dt;class fe{constructor(t){q(this,"parser",new DOMParser),q(this,"serializer",new XMLSerializer),w(this,W,new Map),w(this,Q,new Map),w(this,D,new Map),w(this,U,void 0),w(this,ut,[]),w(this,dt,A.HTML),this.mobi=t}async init(){var t;let e=new Uint8Array;for(let n=0;n<this.mobi.headers.palmdoc.numTextRecords;n++)e=it(e,await this.mobi.loadText(n));const i=Array.from(new Uint8Array(e),n=>String.fromCharCode(n)).join("");k(this,U,[0].concat(Array.from(i.matchAll(Ct),n=>n.index)).map((n,a,r)=>i.slice(n,r[a+1])).map(n=>Uint8Array.from(n,a=>a.charCodeAt(0))).map(n=>({book:this,raw:n})).reduce((n,a)=>{const r=n[n.length-1];return a.start=r?.end??0,a.end=a.start+a.raw.byteLength,n.concat(a)},[])),this.sections=o(this,U).map((n,a)=>({id:a,load:()=>this.loadSection(n),createDocument:()=>this.createDocument(n),size:n.end-n.start}));try{this.landmarks=await this.getGuide();const n=(t=this.landmarks.find(({type:a})=>a?.includes("toc")))==null?void 0:t.href;if(n){const{index:a}=this.resolveHref(n),r=await this.sections[a].createDocument();let l,u=0,m=0;const d=new Map,b=new Map;this.toc=Array.from(r.querySelectorAll("a[filepos]")).reduce((p,c)=>{var h;const f=de(c),g={label:(h=c.innerText)==null?void 0:h.trim(),href:`filepos:${c.getAttribute("filepos")}`},y=f>m?u+1:f===m?u:d.get(f)??Math.max(0,u-1);if(y>u)l?(l.subitems??(l.subitems=[]),l.subitems.push(g),b.set(y,l)):p.push(g);else{const v=b.get(y);v?v.subitems.push(g):p.push(g)}return l=g,u=y,m=f,d.set(f,y),p},[])}}catch(n){console.warn(n)}return k(this,ut,[...new Set(Array.from(i.matchAll(ue),n=>n[1]))].map(n=>({filepos:n,number:Number(n)})).sort((n,a)=>n.number-a.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const t=await this.createDocument(o(this,U)[0]);return Array.from(t.getElementsByTagName("reference"),e=>{var i;return{label:e.getAttribute("title"),type:(i=e.getAttribute("type"))==null?void 0:i.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`}})}async loadResource(t){if(o(this,W).has(t))return o(this,W).get(t);const e=await this.mobi.loadResource(t),i=URL.createObjectURL(new Blob([e]));return o(this,W).set(t,i),i}async loadRecindex(t){return this.loadResource(Number(t)-1)}async replaceResources(t){for(const e of t.querySelectorAll("img[recindex]")){const i=e.getAttribute("recindex");try{e.src=await this.loadRecindex(i)}catch{console.warn(`Failed to load image ${i}`)}}for(const e of t.querySelectorAll("[mediarecindex]")){const i=e.getAttribute("mediarecindex"),n=e.getAttribute("recindex");try{e.src=await this.loadRecindex(i),n&&(e.poster=await this.loadRecindex(n))}catch{console.warn(`Failed to load media ${i}`)}}for(const e of t.querySelectorAll("[filepos]")){const i=e.getAttribute("filepos");e.href=`filepos:${i}`}}async loadText(t){if(o(this,Q).has(t))return o(this,Q).get(t);const{raw:e}=t,i=o(this,ut).filter(({number:r})=>r>=t.start&&r<t.end).map(r=>({...r,offset:r.number-t.start}));let n=e;i.length&&(n=e.subarray(0,i[0].offset),i.forEach(({filepos:r,offset:l},u)=>{const m=i[u+1],d=this.mobi.encode(`<a id="filepos${r}"></a>`);n=Et(n,d,e.subarray(l,m?.offset))}));const a=this.mobi.decode(n).replaceAll(Ct,"");return o(this,Q).set(t,a),a}async createDocument(t){const e=await this.loadText(t);return this.parser.parseFromString(e,o(this,dt))}async loadSection(t){if(o(this,D).has(t))return o(this,D).get(t);const e=await this.createDocument(t),i=e.createElement("style");e.head.append(i),i.append(e.createTextNode(`blockquote {
            margin-block-start: 0;
            margin-block-end: 0;
            margin-inline-start: 1em;
            margin-inline-end: 0;
        }`)),await this.replaceResources(e);const n=this.serializer.serializeToString(e),a=URL.createObjectURL(new Blob([n],{type:o(this,dt)}));return o(this,D).set(t,a),a}resolveHref(t){const e=t.match(/filepos:(.*)/)[1],i=Number(e);return{index:o(this,U).findIndex(n=>n.end>i),anchor:n=>n.getElementById(`filepos${e}`)}}splitTOCHref(t){const e=t.match(/filepos:(.*)/)[1],i=Number(e);return[o(this,U).findIndex(n=>n.end>i),`filepos${e}`]}getTOCFragment(t,e){return t.getElementById(e)}isExternal(t){return/^(?!blob|filepos)\w+:/i.test(t)}destroy(){for(const t of o(this,W).values())URL.revokeObjectURL(t);for(const t of o(this,D).values())URL.revokeObjectURL(t)}}W=new WeakMap,Q=new WeakMap,D=new WeakMap,U=new WeakMap,ut=new WeakMap,dt=new WeakMap;const It=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,ge=/kindle:pos:fid:(\w+):off:(\w+)/,pe=s=>{const[t,e,i]=s.match(It).slice(1);return{resourceType:t,id:parseInt(e,32),type:i}},Ut=s=>{const[t,e]=s.match(ge).slice(1);return{fid:parseInt(t,32),off:parseInt(e,32)}},Bt=(s=0,t=0)=>`kindle:pos:fid:${s.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,Ot=s=>{const t=s.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,e,i]=t;return`[${e}="${CSS.escape(i)}"]`},me=async(s,t,e)=>{const i=[];s.replace(t,(...a)=>(i.push(a),null));const n=[];for(const a of i)n.push(await e(...a));return s.replace(t,()=>n.shift())},we=s=>{for(const t of s){if(t==="page-spread-left"||t==="rendition:page-spread-left")return"left";if(t==="page-spread-right"||t==="rendition:page-spread-right")return"right";if(t==="rendition:page-spread-center")return"center"}};var E,tt,z,H,N,B,O,L,vt,Rt,F,ft,gt,kt;class be{constructor(t){w(this,gt),q(this,"parser",new DOMParser),q(this,"serializer",new XMLSerializer),w(this,E,new Map),w(this,tt,new Map),w(this,z,new Map),w(this,H,{}),w(this,N,void 0),w(this,B,void 0),w(this,O,new Uint8Array),w(this,L,new Uint8Array),w(this,vt,-1),w(this,Rt,-1),w(this,F,A.XHTML),w(this,ft,new Map),this.mobi=t}async init(){var t,e,i,n;const a=this.mobi.loadRecord.bind(this.mobi),{kf8:r}=this.mobi.headers;try{const c=await a(r.fdst),h=x(Zt,c);if(h.magic!=="FDST")throw new Error("Missing FDST record");const f=Array.from({length:h.numEntries},(g,y)=>12+y*8).map(g=>[M(c.slice(g,g+4)),M(c.slice(g+4,g+8))]);o(this,H).fdstTable=f,k(this,B,f[f.length-1][1])}catch{}const l=(await rt(r.skel,a)).table.map(({name:c,tagMap:h},f)=>({index:f,name:c,numFrag:h[1][0],offset:h[6][0],length:h[6][1]})),u=await rt(r.frag,a),m=u.table.map(({name:c,tagMap:h})=>({insertOffset:parseInt(c),selector:u.cncx[h[2][0]],index:h[4][0],offset:h[6][0],length:h[6][1]}));o(this,H).skelTable=l,o(this,H).fragTable=m,k(this,N,l.reduce((c,h)=>{const f=c[c.length-1],g=f?.fragEnd??0,y=g+h.numFrag,v=m.slice(g,y),R=h.length+v.map(S=>S.length).reduce((S,pt)=>S+pt),T=(f?.totalLength??0)+R;return c.concat({skel:h,frags:v,fragEnd:y,length:R,totalLength:T})},[]));const d=await this.getResourcesByMagic(["RESC","PAGE"]),b=new Map;if(d.RESC){const c=await this.mobi.loadRecord(d.RESC),h=this.mobi.decode(c.slice(16)).replace(/\0/g,""),f=h.search(/\?>/),g=`<package>${h.slice(f)}</package>`,y=this.parser.parseFromString(g,A.XML);for(const v of y.querySelectorAll("spine > itemref")){const R=parseInt(v.getAttribute("skelid"));b.set(R,we(((t=v.getAttribute("properties"))==null?void 0:t.split(" "))??[]))}}this.sections=o(this,N).map((c,h)=>c.frags.length?{id:h,load:()=>this.loadSection(c),createDocument:()=>this.createDocument(c),size:c.length,pageSpread:b.get(h)}:{linear:"no"});try{const c=await this.mobi.getNCX(),h=({label:f,pos:g,children:y})=>{const[v,R]=g,T=Bt(v,R),S=o(this,tt).get(v);return S?S.push(R):o(this,tt).set(v,[R]),{label:I(f),href:T,subitems:y?.map(h)}};this.toc=c?.map(h),this.landmarks=await this.getGuide()}catch(c){console.warn(c)}const{exth:p}=this.mobi.headers;return this.dir=p.pageProgressionDirection,this.rendition={layout:p.fixedLayout==="true"?"pre-paginated":"reflowable",viewport:Object.fromEntries(((n=(i=(e=p.originalResolution)==null?void 0:e.split("x"))==null?void 0:i.slice(0,2))==null?void 0:n.map((c,h)=>[h?"height":"width",c]))??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(t){const e={},i=this.mobi.headers.kf8.resourceStart,n=this.mobi.pdb.numRecords;for(let a=i;a<n;a++)try{const r=await this.mobi.loadMagic(a),l=t.find(u=>u===r);l&&(e[l]=a)}catch{}return e}async getGuide(){const t=this.mobi.headers.kf8.guide;if(t<4294967295){const e=this.mobi.loadRecord.bind(this.mobi),{table:i,cncx:n}=await rt(t,e);return i.map(({name:a,tagMap:r})=>{var l,u;return{label:n[r[1][0]]??"",type:a?.split(/\s/),href:Bt(((l=r[6])==null?void 0:l[0])??((u=r[3])==null?void 0:u[0]))}})}}async loadResourceBlob(t){var e;const{resourceType:i,id:n,type:a}=pe(t),r=i==="flow"?await this.loadFlow(n):await this.mobi.loadResource(n-1),l=[A.XHTML,A.HTML,A.CSS,A.SVG].includes(a)?await this.replaceResources(this.mobi.decode(r)):r,u=a===A.SVG?this.parser.parseFromString(l,a):null;return[new Blob([l],{type:a}),(e=u?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image"))!=null&&e.length?u.documentElement:null]}async loadResource(t){if(o(this,E).has(t))return o(this,E).get(t);const[e,i]=await this.loadResourceBlob(t),n=i?t:URL.createObjectURL(e);return i&&o(this,ft).set(n,i),o(this,E).set(t,n),n}replaceResources(t){const e=new RegExp(It,"g");return me(t,e,this.loadResource.bind(this))}async loadRaw(t,e){const i=e-o(this,O).length,n=o(this,B)==null?1/0:o(this,B)-o(this,L).length-t;if(i<0||i<n){for(;o(this,O).length<e;){const r=++xt(this,vt)._,l=await this.mobi.loadText(r);k(this,O,it(o(this,O),l))}return o(this,O).slice(t,e)}for(;o(this,B)-o(this,L).length>t;){const r=this.mobi.headers.palmdoc.numTextRecords-1-++xt(this,Rt)._,l=await this.mobi.loadText(r);k(this,L,it(l,o(this,L)))}const a=o(this,B)-o(this,L).length;return o(this,L).slice(t-a,e-a)}loadFlow(t){if(t<4294967295)return this.loadRaw(...o(this,H).fdstTable[t])}async loadText(t){const{skel:e,frags:i,length:n}=t,a=await this.loadRaw(e.offset,e.offset+n);let r=a.slice(0,e.length);for(const l of i){const u=l.insertOffset-e.offset,m=e.length+l.offset,d=a.slice(m,m+l.length);r=Et(r.slice(0,u),d,r.slice(u));const b=o(this,tt).get(l.index);if(b)for(const p of b){const c=this.mobi.decode(d).slice(p),h=Ot(c);P(this,gt,kt).call(this,l.index,p,h)}}return this.mobi.decode(r)}async createDocument(t){const e=await this.loadText(t);return this.parser.parseFromString(e,o(this,F))}async loadSection(t){if(o(this,E).has(t))return o(this,E).get(t);const e=await this.loadText(t),i=await this.replaceResources(e);let n=this.parser.parseFromString(i,o(this,F));n.querySelector("parsererror")&&(k(this,F,A.HTML),n=this.parser.parseFromString(i,o(this,F)));for(const[r,l]of o(this,ft))for(const u of n.querySelectorAll(`img[src="${r}"]`))u.replaceWith(l);const a=URL.createObjectURL(new Blob([this.serializer.serializeToString(n)],{type:o(this,F)}));return o(this,E).set(t,a),a}getIndexByFID(t){return o(this,N).findIndex(e=>e.frags.some(i=>i.index===t))}async resolveHref(t){var e;const{fid:i,off:n}=Ut(t),a=this.getIndexByFID(i);if(a<0)return;const r=(e=o(this,z).get(i))==null?void 0:e.get(n);if(r)return{index:a,anchor:h=>h.querySelector(r)};const{skel:l,frags:u}=o(this,N)[a],m=u.find(h=>h.index===i),d=l.offset+l.length+m.offset,b=await this.loadRaw(d,d+m.length),p=this.mobi.decode(b).slice(n),c=Ot(p);return P(this,gt,kt).call(this,i,n,c),{index:a,anchor:h=>h.querySelector(c)}}splitTOCHref(t){const e=Ut(t);return[this.getIndexByFID(e.fid),e]}getTOCFragment(t,{fid:e,off:i}){var n;const a=(n=o(this,z).get(e))==null?void 0:n.get(i);return t.querySelector(a)}isExternal(t){return/^(?!blob|kindle)\w+:/i.test(t)}destroy(){for(const t of o(this,E).values())URL.revokeObjectURL(t)}}E=new WeakMap,tt=new WeakMap,z=new WeakMap,H=new WeakMap,N=new WeakMap,B=new WeakMap,O=new WeakMap,L=new WeakMap,vt=new WeakMap,Rt=new WeakMap,F=new WeakMap,ft=new WeakMap,gt=new WeakSet,kt=function(s,t,e){const i=o(this,z).get(s);if(i)i.set(t,e);else{const n=new Map;o(this,z).set(s,n),n.set(t,e)}}}}]);
